---
layout: posts
title: 浏览器工作原理
date: 2024-11-04 23:14:47
tags:
---


## 前置知识

### 进程和线程

进程：就是程序的运行实例，当我们启动一个程序，操作系统会创建一个内存，里面可以有多个线程。
线程：负责当前任务中程序的执行

特点：
- 同一个进程的线程数据共享
- 一个线程崩溃，整个进程崩溃
- 进程关闭后，内存会回收
- 不同进程相互隔离，通过IPC通讯


## chrome多进程架构

chorme架构主要包括了浏览器主进程，网络进程，GPU进程，渲染进程，插件进程，缓存进程。浏览器默认情况下会为每个标签页创建一个进程

![[浏览器原理]]


## 工作原理

- 浏览器主进程：获取 URL，格式正确会给 URL 加上协议，通过进程间通信发送给网络进程
- 网络进程：
  - 先查看是否有缓存资源，如果没有就先进行 DNS 解析，将域名转为 ip 地址。如果协议是 HTTPS 那么会建立 TLS 连接，
  - 然后浏览器构建请求头和请求体向服务器发送请求，服务端返回响应内容。
  - SafeBrowsing 对返回站点内容做检查，如果是不安全的就会给与安全提示
  - 一旦浏览器接受就先解析响应行（可能会有重定向），然后是响应头，如果 content-type 是 `text/html` 那么就会开启一个渲染进程。
  每个域名都会开启一个渲染进程，同域名一般只会有一个，这种方式可以避免不同标签页之间数据共享，卡死
- 渲染进程：
	- 通过 IPC 管道接受网络进程响应体的内容，这时候浏览器进入白屏等待渲染进程进行渲染。
	- HTML 解析成 DOM 树：当解析器发现非阻塞资源，例如一张图片，浏览器会请求这些资源并且继续解析。当遇到一个 CSS 文件时，解析也可以继续进行，但是对于 `<script>` 标签（特别是没有 [`async`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function) 或者 `defer` 属性的）会阻塞渲染并停止 HTML 的解析。尽管浏览器的预加载扫描器加速了这个过程，但过多的脚本仍然是一个重要的瓶颈。
	- 计算样式：处理 CSS 并构建 CSSOM 树
	- JavaScript 编译：[[js编译原理]]
	  >chrome 使用的渲染引擎是 Blink，而 js 引擎是 V 8，渲染引擎在渲染时遇到 js 会去执行代码调用 js 引擎。
	- 布局：根据 DOM 树和已经计算好的样式，生成一个布局树。
	- 分层
	- 绘制
	- 合成：
		- 主线程完成以上的工作后，将信息传递给合成器线程，将每个图层切分为很多图块，将每个图块发送给栅格线程，每个栅格线程会栅格化图块。
		- 根据这些信息，合成器线程生成合成器帧传递给浏览器进程，然后给到 GPU，渲染到屏幕上
	- 交互

> HTML 解析，css 样式解析，js 编译都是在渲染进程的主线程中执行，当重绘和重排比较频繁时，js 执行时间过长，容易造成页面的卡顿。

## 参考链接

- [浏览器历史和渲染原理](https://www.bilibili.com/video/BV1tc41157Va/?spm_id_from=333.337.search-card.all.click&vd_source=115cedcdb1996c6483fb453252e441e6)
- [MDN：浏览器工作原理](https://developer.mozilla.org/zh-CN/docs/Web/Performance/How_browsers_work)
- [干货】浏览器是如何运作的？](https://www.bilibili.com/video/BV1x54y1B7RE/?spm_id_from=333.788.recommend_more_video.-1&vd_source=115cedcdb1996c6483fb453252e441e6)

