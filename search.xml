<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hexo + github action 实现自动化部署</title>
    <url>/myBlog/2024/11/05/Hexo-git-acition-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>首先需要一个可以 build 的 hexo 项目，确保在本地实现 <code>npm run build</code> 指令。</p>
<h2 id="为什么选择-git-action-git-pages-模式"><a href="#为什么选择-git-action-git-pages-模式" class="headerlink" title="为什么选择 git action + git pages 模式"></a>为什么选择 git action + git pages 模式</h2><p>Git action 不仅仅是一个 CI&#x2F;CD 平台，更是一个自动化工作流的平台。他很好的兼容了 github 的功能，除了常规的 ci&#x2F;cd 流程的兼容，还可以对用户的 issue，贡献者参与等事件都做出反应，之后开始配置过的工作流。<br>除此之外，github 还提供了静态资源托管服务 git pages，相当于给我们了一个服务器来部署一个人人都可以访问的站点，这样我们就<strong>无需购买配置服务器</strong>。<br>同时GitHub Pages 在你手动推送新代码到配置的分支（如 main、master 或 gh-pages）时，会<strong>自动重新构建并发布</strong>你的静态网站。这也就意味着我们只需要将 build 的文件发送到项目任意分支就可以。</p>
<p>我们可以在如下标识处找到这两个功能入口</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241105103438.png"
                     
                ></p>
<h2 id="让我们开始吧"><a href="#让我们开始吧" class="headerlink" title="让我们开始吧"></a>让我们开始吧</h2><p>来到 setting，配置 github api 的 token，以授权访问我们的 github repo。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241105112250.png"
                     
                ></p>
<p>再来到仓库的 setting 下把 token 配置进去<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241105112403.png"
                     
                ></p>
<p>这样我们的 actions 就不用去输入明文密码来执行自动化任务了，相应的会使用我们配置的名称来进行身份验证。</p>
<p>接着来到 action 底下新建第一条工作流</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241105112620.png"
                     
                ></p>
<p>Yml 文件里面是我们的工作流配置，包括触发事件，工作流程，复制粘贴我的配置，并且修改里面的仓库地址，node 版本。做你想要的修改。然后提交文档</p>
<pre><code class="yml">name: Deploy Hexo to GitHub Pages1

on:
  push:
    branches:
      - master  # 当推送到 main 分支时触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
</code></pre>
]]></content>
      <tags>
        <tag>hexo</tag>
        <tag>github action</tag>
      </tags>
  </entry>
  <entry>
    <title>VUE是如何渲染SFC的</title>
    <url>/myBlog/2024/09/28/VUE%E6%98%AF%E5%A6%82%E4%BD%95%E6%B8%B2%E6%9F%93SPA%E7%9A%84/</url>
    <content><![CDATA[<h2 id="涉及到的知识面"><a href="#涉及到的知识面" class="headerlink" title="涉及到的知识面"></a>涉及到的知识面</h2><p>正则表达式，数据劫持，虚拟 DOM</p>
<h2 id="简易流程加虚拟-DOM"><a href="#简易流程加虚拟-DOM" class="headerlink" title="简易流程加虚拟 DOM"></a>简易流程加虚拟 DOM</h2><p>为了可以介绍清楚整个转化流程，我将拿一个简单地 <code>.vue</code> 文件举例子，并把整个渲染流程代码逐个拆分到每个步骤中去。这个例子会涉及响应式和虚拟 DOM。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;h1&gt;&#123;&#123; title &#125;&#125;&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;&#123;&#123; content &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">    data() &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            title: &quot;this is title&quot;,</span><br><span class="line">            content: &quot;this is Content&quot;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></div>

<h3 id="SFC转为JS"><a href="#SFC转为JS" class="headerlink" title="SFC转为JS"></a>SFC转为JS</h3><p>由于浏览器只能识别 <code>http | js | css</code>  文件，所以 <code>vite</code> 官方 提供一个<code>@vitejs/plugin-vue</code> 组件，可以把这个插件想象成编译器，把 <code>.vue</code> 文件转化为 <code>.js</code>文件。为了更好的探究实现过程，我决定手写，这时候就涉及到读取vue文件，把内容转为字符串输出。</p>
<p>早期，浏览器是一个沙盒，它不允许我们操作本地文件，通常都是后端处理，前端使用 <code>fetch</code> API 或 <code>XMLHttpRequest</code> 来发送请求到后端拿到数据。浏览器只允许同源的Ajax操作，如果跨域，就必须使用CORS权限。<br>除此之外，还有纯前端操作文件的方法。参考<a class="link"   href="https://blog.csdn.net/xgangzai/article/details/129605068" ># 使用File System Access API让浏览器拥有操作本地文件的能力<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。<br>纯前端方法不是很流行，所以我不做研究。</p>
<p>利用 <code>webpack</code> ，相当于是后端的处理方式，由于 <code>webpack</code> 运行在 <code>Nodejs</code> 上，所以webpack内部在编译的过程帮我们处理了读取文件的步骤，我们只需配置一个loader，参数是从目标文件拿到的字符串信息，返回一个字符串webpack会生成对应的js文件。在loader中编写我们的处理逻辑。</p>
<p>以下手写webpack-loader ，模拟了<code>@vitejs/plugin-vue</code>的编译功能，把vue转化为了js。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> regTemplate = <span class="regexp">/\&lt;template\&gt;(.+?)\&lt;\/template\&gt;/</span></span><br><span class="line"><span class="keyword">const</span> regScript = <span class="regexp">/\&lt;script\&gt;(.+?)\&lt;\/script\&gt;/</span></span><br><span class="line"><span class="keyword">const</span> regFirstSign = <span class="regexp">/(&#123;)/</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> _source = source.<span class="title function_">replace</span>(<span class="regexp">/[\r\n]/g</span>,<span class="string">&#x27;&#x27;</span>)  </span><br><span class="line">      <span class="keyword">const</span> template = _source.<span class="title function_">match</span>(regTemplate)[<span class="number">1</span>]</span><br><span class="line">      <span class="keyword">const</span> script = _source.<span class="title function_">match</span>(regScript)[<span class="number">1</span>]</span><br><span class="line">      <span class="keyword">const</span> finalScript = script.<span class="title function_">replace</span>(regFirstSign, <span class="string">&#x27;$1 template:&#x27;</span> + <span class="string">&#x27;`&#x27;</span> + template + <span class="string">&#x27;`&#x27;</span> + <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(finalScript)</span><br><span class="line">      <span class="keyword">return</span> finalScript</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//finalScript like this </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123; <span class="attr">template</span>:<span class="string">`    &lt;h1&gt;&#123;&#123; title &#125;&#125;&lt;/h1&gt;    &lt;p&gt;&#123;&#123; content &#125;&#125;&lt;/p&gt;`</span>,    <span class="title function_">data</span>(<span class="params"></span>) &#123;        <span class="keyword">return</span> &#123;            <span class="attr">title</span>: <span class="string">&quot;this is </span></span><br><span class="line"><span class="string">title&quot;</span>,            <span class="attr">content</span>: <span class="string">&quot;this is Content&quot;</span>,        &#125;    &#125;&#125;</span><br></pre></td></tr></table></figure></div>


<h3 id="template模板分析，编译"><a href="#template模板分析，编译" class="headerlink" title="template模板分析，编译"></a>template模板分析，编译</h3><p>template分为标签，属性，内容。</p>
<ul>
<li>标签有可能是原生的html，也有可能是组件</li>
<li>属性也有可能是vue框架属性，自定义属性<br>vue会对这些模板做过滤，生成AST树。</li>
</ul>
<p>首先把文件里的template和data解构出来</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">App</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//解构出被loader处理过的App.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;template,<span class="attr">data</span>: generate &#125; = <span class="title class_">App</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data  = <span class="title function_">reactive</span>(<span class="title function_">generate</span>())</span><br></pre></td></tr></table></figure></div>

<p>然后对模板进行分析编译，编译包括匹配每个标签和内容，然后生成虚拟的DOM。</p>
<blockquote>
<p>这里是一个简易版本，只针对原生标签的innerHtml做了分析。这个 innerHtml 也并非表达式。除此之外，也没有 vue 的特殊的事件属性写法</p>
</blockquote>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> regHtml = <span class="regexp">/\&lt;(.+?)\&gt;\&#123;\&#123;(.+?)\&#125;\&#125;\&lt;\/.+?\&gt;/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">compileTemplate</span> = (<span class="params">template,data</span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">//vDOM原来是对象，这里用数组只是为了展示虚拟节点的思想</span></span><br><span class="line">    <span class="keyword">const</span> vDOM = []</span><br><span class="line">    <span class="keyword">const</span> matched = template.<span class="title function_">match</span>(<span class="keyword">new</span> <span class="title class_">RegExp</span>(regHtml,<span class="string">&quot;ig&quot;</span>))</span><br><span class="line">    matched.<span class="title function_">forEach</span>(<span class="function">(<span class="params">tag,index</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> [,tagName,key] = tag.<span class="title function_">match</span>(<span class="keyword">new</span> <span class="title class_">RegExp</span>(regHtml,<span class="string">&quot;i&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        vDOM[index] = &#123;</span><br><span class="line">            <span class="attr">tag</span>:tagName,</span><br><span class="line">            <span class="attr">children</span>: data[key.<span class="title function_">trim</span>()]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vDOM</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<h3 id="render虚拟DOM"><a href="#render虚拟DOM" class="headerlink" title="render虚拟DOM"></a>render虚拟DOM</h3><p>初次渲染只需要把虚拟DOM渲染到真实DOM上</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">app,template,data</span>)=&gt;&#123;</span><br><span class="line">    state.<span class="property">_vDOM</span> = <span class="title function_">compileTemplate</span>(template,data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> fragment  =  <span class="variable language_">document</span>.<span class="title function_">createDocumentFragment</span>()</span><br><span class="line">    <span class="comment">//只做一层的渲染</span></span><br><span class="line">    state.<span class="property">_vDOM</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">vnode</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;tag,children&#125; = vnode</span><br><span class="line"></span><br><span class="line">        <span class="comment">//并且只做innerText</span></span><br><span class="line">        <span class="keyword">const</span> node = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(tag)</span><br><span class="line">        node.<span class="property">innerText</span> = children</span><br><span class="line"></span><br><span class="line">        fragment.<span class="title function_">appendChild</span>(node)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    app.<span class="title function_">appendChild</span>(fragment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<h3 id="数据更新，重新渲染"><a href="#数据更新，重新渲染" class="headerlink" title="数据更新，重新渲染"></a>数据更新，重新渲染</h3><p>当数据更新，我们如何追踪这种变化？es6的proxy给了我们答案，通过一种数据劫持的方案，我们可以检测到数据变化，并且做一些额外的（更新视图）的动作。<br>以下是proxy ，set的handler的实现。<br>当数据变更时，我们会根据新的data重新编译模板，获取新的虚拟DOM，通过比较新老虚拟DOM，获取发生变化的虚拟DOM，并在真实DOM上重新渲染这部分的值。</p>
<blockquote>
<p>这种比较涉及了diff算法，这里没有去实现</p>
</blockquote>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">update</span> = (<span class="params">template,vDOM,data,value</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> newVDOM = <span class="title function_">compileTemplate</span>(template,data)</span><br><span class="line"></span><br><span class="line">    newVDOM.<span class="title function_">forEach</span>( <span class="function">(<span class="params">vnode,index</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(vnode.<span class="property">children</span> !== vDOM[index].<span class="property">children</span>)&#123;</span><br><span class="line">            <span class="title function_">patch</span>(value,index)</span><br><span class="line">            vDOM.<span class="title function_">splice</span>(<span class="number">0</span>, vDOM.<span class="property">length</span>, ...newVDOM); <span class="comment">// 直接用新内容替换原有内容</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">patch</span> = (<span class="params">value,index</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> childNodes = state.<span class="property">_app</span>.<span class="property">children</span></span><br><span class="line">    childNodes[index].<span class="property">innerText</span> = value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createSetter</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">set</span> = (<span class="params">target,key,value,receiver</span>) =&gt;&#123;</span><br><span class="line">        <span class="keyword">const</span> oldValue = target[key]</span><br><span class="line">        <span class="comment">//一旦执行这一句，那么target的值立马会发生变化，也就是说，下面的代码的target会立马变成新的值。所以update的参数将会是更新后的data</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target,key,value,receiver)</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(target,key))&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;响应式新增&quot;</span>, + value)</span><br><span class="line">            <span class="title function_">update</span>(state.<span class="property">_template</span>,state.<span class="property">_vDOM</span>,state.<span class="property">_data</span>,value)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(value !== oldValue)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;响应式修改&quot;</span>, key + <span class="string">&quot; = &quot;</span> +  value)</span><br><span class="line">                <span class="title function_">update</span>(state.<span class="property">_template</span>,state.<span class="property">_vDOM</span>,state.<span class="property">_data</span>,value)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> set</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> get = <span class="title function_">createGetter</span>()</span><br><span class="line"><span class="keyword">const</span> set = <span class="title function_">createSetter</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutableHandler = &#123;</span><br><span class="line">    get,</span><br><span class="line">    set</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="流程小结"><a href="#流程小结" class="headerlink" title="流程小结"></a>流程小结</h3><p> 我们需要拆分一下概念，整个实现涉及到了 vue 的响应式，和虚拟 DOM。</p>
<ul>
<li>响应式，使得开发者不需要手动管理 DOM 的更新，Vue 会根据数据的变化自动重新渲染相关部分，减少了出错的可能性。</li>
<li>而虚拟 DOM ，避免了 DOM 的频繁更新，提高性能。<br>Vue 的整个流程是可以绕过虚拟 DOM 实现的，接下来我将实现一个更加复杂的 vue 渲染 <code>.vue</code> 文件的流程。</li>
</ul>
<h2 id="完整流程"><a href="#完整流程" class="headerlink" title="完整流程"></a>完整流程</h2><p>以上是 vue 的一个简易版本，由于我认识有限，接下来的内容将会不断更新，以便还原整个 vue 文件运行的流程。</p>
<h3 id="Vue-文件转为-Js-文件"><a href="#Vue-文件转为-Js-文件" class="headerlink" title=".Vue 文件转为. Js 文件"></a>.Vue 文件转为. Js 文件</h3><h3 id="CreateApp-入口函数"><a href="#CreateApp-入口函数" class="headerlink" title="CreateApp 入口函数"></a>CreateApp 入口函数</h3><h3 id="函件加载"><a href="#函件加载" class="headerlink" title="函件加载"></a>函件加载</h3><h2 id="虚拟-DOM"><a href="#虚拟-DOM" class="headerlink" title="虚拟 DOM"></a>虚拟 DOM</h2><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a class="link"   href="https://jonny-wei.github.io/blog/vue/vue/vue-observer.html#%E5%A6%82%E4%BD%95%E4%BE%A6%E6%B5%8B%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%98%E5%8C%96" >响应式原理<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   href="https://blog.poetries.top/FE-Interview-Questions/principle-docs/comprehensive/07-%E8%99%9A%E6%8B%9FDOM%EF%BC%88%E4%B8%80%EF%BC%89.html#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF-vdom" >什么是虚拟 DOM<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   href="https://www.bilibili.com/video/BV1L94y1U73p/?spm_id_from=333.788&vd_source=115cedcdb1996c6483fb453252e441e6" ># JS实现『从工程化到Vue』【上机题】<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   href="https://www.bilibili.com/video/BV1mK421v7PH?p=4&vd_source=115cedcdb1996c6483fb453252e441e6" ># 【小野森森】虚拟DOM怎么了？【前端基础】<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
]]></content>
      <tags>
        <tag>Vue</tag>
        <tag>SFC</tag>
        <tag>渲染原理</tag>
        <tag>前端开发</tag>
      </tags>
  </entry>
  <entry>
    <title>buy-me-coffee-dapp</title>
    <url>/myBlog/2024/12/25/buy-me-coffee-dapp/</url>
    <content><![CDATA[<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link"   href="https://www.youtube.com/watch?v=cxxKdJk55Lk&t=1016s" >buy-me-a-coffee<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h2><p>Solidity，hardhat, react, ether</p>
<h2 id="编写合约"><a href="#编写合约" class="headerlink" title="编写合约"></a>编写合约</h2><div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: UNLICENSED</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.28</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">BuyMeACoffee</span> &#123;</span><br><span class="line">    <span class="comment">//Event to emit when a memo is created</span></span><br><span class="line">    event <span class="title class_">NewMemo</span>(</span><br><span class="line">        address indexed <span class="keyword">from</span>,</span><br><span class="line">        uint256 timestamp,</span><br><span class="line">        string name,</span><br><span class="line">        string message</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    struct <span class="title class_">Memo</span>&#123;</span><br><span class="line">        address <span class="keyword">from</span>;</span><br><span class="line">        uint256 timestamp;</span><br><span class="line">        string name;</span><br><span class="line">        string message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Memo</span>[] memos;</span><br><span class="line"></span><br><span class="line">    address payable public owner;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">        owner = <span class="title function_">payable</span>(msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">buyCoffee</span>(<span class="params">string memory _name,string memory _message</span>) payable public &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt; <span class="number">0</span>,<span class="string">&quot;can&#x27;t buy coffee with 0 eth&quot;</span>);</span><br><span class="line"></span><br><span class="line">        memos.<span class="title function_">push</span>(<span class="title class_">Memo</span>(</span><br><span class="line">            msg.<span class="property">sender</span>,</span><br><span class="line">            block.<span class="property">timestamp</span>,</span><br><span class="line">            _name,</span><br><span class="line">            _message</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">NewMemo</span>(</span><br><span class="line">            msg.<span class="property">sender</span>,</span><br><span class="line">            block.<span class="property">timestamp</span>,</span><br><span class="line">            _name,</span><br><span class="line">            _message</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">withdrawTips</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(owner.<span class="title function_">send</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>));</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getMemos</span>(<span class="params"></span>) public view <span class="title function_">returns</span>(<span class="params">Memo[] memory</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> memos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>涉及了资金的转入，转出，事件的发送</p>
<h2 id="部署验证测试合约"><a href="#部署验证测试合约" class="headerlink" title="部署验证测试合约"></a>部署验证测试合约</h2><h3 id="本地测试的代码"><a href="#本地测试的代码" class="headerlink" title="本地测试的代码"></a>本地测试的代码</h3><div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> hre = <span class="built_in">require</span>(<span class="string">&quot;hardhat&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//returns the Ethereum balance of a given address.</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBalance</span>(<span class="params">address</span>)&#123;</span><br><span class="line">    <span class="comment">//hardhat-network provider. get balance from this network</span></span><br><span class="line">    <span class="keyword">const</span> balanceBigInt = <span class="keyword">await</span> hre.<span class="property">ethers</span>.<span class="property">provider</span>.<span class="title function_">getBalance</span>(address);</span><br><span class="line">    <span class="keyword">return</span> hre.<span class="property">ethers</span>.<span class="title function_">formatEther</span>(balanceBigInt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">printBalance</span>(<span class="params">addresses</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> address <span class="keyword">of</span> addresses)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`address <span class="subst">$&#123;idx&#125;</span> balance:`</span>,<span class="keyword">await</span> <span class="title function_">getBalance</span>(address));</span><br><span class="line">        idx++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">printMemos</span>(<span class="params">memos</span>) &#123;</span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">const</span> memo <span class="keyword">of</span> memos)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`at <span class="subst">$&#123;memo.timestamp&#125;</span> <span class="subst">$&#123;memo.name&#125;</span> ,<span class="subst">$&#123;memo.<span class="keyword">from</span>&#125;</span> said <span class="subst">$&#123;memo.message&#125;</span>`</span>)</span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//get example account </span></span><br><span class="line">    <span class="keyword">const</span> [owner,tipper,tipper2,tipper3] = <span class="keyword">await</span> hre.<span class="property">ethers</span>.<span class="title function_">getSigners</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`owner is :`</span>,owner.<span class="property">address</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get the contract to deploy</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">BuyMeACoffee</span> = <span class="keyword">await</span> hre.<span class="property">ethers</span>.<span class="title function_">getContractFactory</span>(<span class="string">&quot;BuyMeACoffee&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> buyMeACoffee = <span class="keyword">await</span> <span class="title class_">BuyMeACoffee</span>.<span class="title function_">deploy</span>();</span><br><span class="line">    <span class="keyword">await</span> buyMeACoffee.<span class="title function_">waitForDeployment</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">        <span class="string">`contract has been deployed successfully, contract address is <span class="subst">$&#123;buyMeACoffee.target&#125;</span>`</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`owner is :`</span>,<span class="keyword">await</span> buyMeACoffee.<span class="title function_">owner</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//check the balance before the coffee purchase</span></span><br><span class="line">    <span class="keyword">const</span> addresses = [owner.<span class="property">address</span>,tipper.<span class="property">address</span>,buyMeACoffee.<span class="property">target</span>]</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;== start ==&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">printBalance</span>(addresses);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//by owner a coffee;</span></span><br><span class="line">    <span class="keyword">const</span> tip = &#123;<span class="attr">value</span>:hre.<span class="property">ethers</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;1&quot;</span>)&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//connect wallet to contract. call the contract function</span></span><br><span class="line">    <span class="keyword">await</span> buyMeACoffee.<span class="title function_">connect</span>(tipper).<span class="title function_">buyCoffee</span>(<span class="string">&quot;ly&quot;</span>,<span class="string">&quot;hello&quot;</span>,tip);</span><br><span class="line">    <span class="keyword">await</span> buyMeACoffee.<span class="title function_">connect</span>(tipper2).<span class="title function_">buyCoffee</span>(<span class="string">&quot;ly2&quot;</span>,<span class="string">&quot;hello2&quot;</span>,tip);</span><br><span class="line">    <span class="keyword">await</span> buyMeACoffee.<span class="title function_">connect</span>(tipper3).<span class="title function_">buyCoffee</span>(<span class="string">&quot;ly3&quot;</span>,<span class="string">&quot;hello3&quot;</span>,tip);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;== bought coffee ==&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">printBalance</span>(addresses);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//withdraw funds</span></span><br><span class="line">    <span class="keyword">await</span> buyMeACoffee.<span class="title function_">connect</span>(owner).<span class="title function_">withdrawTips</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;== withdraw tips ==&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">printBalance</span>(addresses);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//read all memos left for the owner</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;== memos ==&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> memos = <span class="keyword">await</span> buyMeACoffee.<span class="title function_">getMemos</span>();</span><br><span class="line">    <span class="title function_">printMemos</span>(memos)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>()</span><br><span class="line">  .<span class="title function_">then</span>()</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>使用了本地测试网络提供的账户，本地提供的 provider 用来获取本地测试网的数据。并且我们是部署到了本地的测试网。所以我们无需做任何配置，一切都是默认的。</p>
<h3 id="以太坊测试网的代码"><a href="#以太坊测试网的代码" class="headerlink" title="以太坊测试网的代码"></a>以太坊测试网的代码</h3><p>我们仍然需要将代码部署到以太坊测试网，这样所有人可以测试他，并且用假的以太币，并且和别的合约进行交互。</p>
<p>钱包：metamask 代替默认的假钱包<br>Provider：alchemy 代替默认的假 provider，来进行对链的写入读取数据，和钱包的交互，执行合约代码。。。这样我们不需要维护任何的节点。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> hre = <span class="built_in">require</span>(<span class="string">&quot;hardhat&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//get the contract to deploy</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">BuyMeACoffee</span> = <span class="keyword">await</span> hre.<span class="property">ethers</span>.<span class="title function_">getContractFactory</span>(<span class="string">&quot;BuyMeACoffee&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> buyMeACoffee = <span class="keyword">await</span> <span class="title class_">BuyMeACoffee</span>.<span class="title function_">deploy</span>();</span><br><span class="line">        <span class="keyword">await</span> buyMeACoffee.<span class="title function_">waitForDeployment</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">            <span class="string">`contract has been deployed successfully, contract address is <span class="subst">$&#123;buyMeACoffee.target&#125;</span>`</span></span><br><span class="line">        );</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`owner is :`</span>,<span class="keyword">await</span> buyMeACoffee.<span class="title function_">owner</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>()</span><br><span class="line">  .<span class="title function_">then</span>()</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></div>

<p>这里我们需要对 hardhat. Config 进行配置</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;@nomicfoundation/hardhat-toolbox&quot;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;dotenv&#x27;</span>).<span class="title function_">config</span>() <span class="comment">//为了可以使用.env里定义的变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SEPOLIA_URL</span> = process.<span class="property">env</span>.<span class="property">SEPOLIA_URL</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PRIVATE_KEY</span> = process.<span class="property">env</span>.<span class="property">PRIVATE_KEY</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">API_KEY</span> = process.<span class="property">env</span>.<span class="property">API_KEY</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@type</span> import(&#x27;hardhat/config&#x27;).HardhatUserConfig */</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">solidity</span>: <span class="string">&quot;0.8.28&quot;</span>,</span><br><span class="line">  <span class="attr">networks</span>:&#123;</span><br><span class="line">    <span class="attr">sepolia</span>:&#123;</span><br><span class="line">      <span class="attr">url</span>:<span class="variable constant_">SEPOLIA_URL</span>,</span><br><span class="line">      <span class="attr">accounts</span>:[<span class="variable constant_">PRIVATE_KEY</span>],</span><br><span class="line">      <span class="attr">chainId</span>:<span class="number">11155111</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">etherscan</span>: &#123;</span><br><span class="line">    <span class="comment">// Your API key for Etherscan,，允许你在 Hardhat 中自动验证和上传智能合约源代码到 Etherscan。</span></span><br><span class="line">    <span class="comment">//使用 Etherscan 的验证功能可以提高合约的透明度，允许其他开发者和用户查看和审核你的合约代码，增加可信度。</span></span><br><span class="line">    <span class="attr">apiKey</span>: &#123;</span><br><span class="line">      <span class="attr">sepolia</span>:<span class="variable constant_">API_KEY</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>至此，合约被部署到了 sepolia 测试网，那前端如何设计页面并和合约进行互动呢。</p>
<h2 id="客户端开发"><a href="#客户端开发" class="headerlink" title="客户端开发"></a>客户端开发</h2><h3 id="浏览器环境的合约交互"><a href="#浏览器环境的合约交互" class="headerlink" title="浏览器环境的合约交互"></a>浏览器环境的合约交互</h3><p>我们使用 repl 快速搭建环境和前端项目。利用 React，jsx 来搭建我们的客户端。使钱包用户可以方便的和合约进行交互。</p>
<div class="code-container" data-rel="Jsx"><figure class="iseeu highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> abi <span class="keyword">from</span> <span class="string">&#x27;../utils/BuyMeACoffee.json&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ethers &#125; <span class="keyword">from</span> <span class="string">&quot;ethers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Head</span> <span class="keyword">from</span> <span class="string">&#x27;next/head&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Image</span> <span class="keyword">from</span> <span class="string">&#x27;next/image&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useEffect, useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;../styles/Home.module.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Contract Address &amp; ABI</span></span><br><span class="line">  <span class="keyword">const</span> contractAddress = <span class="string">&quot;0xd234976128226C683A3dcc9De834BFC5E2a49586&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> contractABI = abi.<span class="property">abi</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Component state</span></span><br><span class="line">  <span class="keyword">const</span> [currentAccount, setCurrentAccount] = <span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = <span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [message, setMessage] = <span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [memos, setMemos] = <span class="title function_">useState</span>([]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onNameChange</span> = (<span class="params">event</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setName</span>(event.<span class="property">target</span>.<span class="property">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onMessageChange</span> = (<span class="params">event</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setMessage</span>(event.<span class="property">target</span>.<span class="property">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wallet connection logic</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isWalletConnected</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; ethereum &#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> accounts = <span class="keyword">await</span> ethereum.<span class="title function_">request</span>(&#123;<span class="attr">method</span>: <span class="string">&#x27;eth_accounts&#x27;</span>&#125;)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;accounts: &quot;</span>, accounts);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (accounts.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> account = accounts[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;wallet is connected! &quot;</span> + account);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;make sure MetaMask is connected&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error: &quot;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">connectWallet</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;ethereum&#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!ethereum) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;please install MetaMask&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> accounts = <span class="keyword">await</span> ethereum.<span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;eth_requestAccounts&#x27;</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">setCurrentAccount</span>(accounts[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">buyCoffee</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;ethereum&#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (ethereum) &#123;</span><br><span class="line">        <span class="keyword">const</span> provider = <span class="keyword">new</span> ethers.<span class="property">providers</span>.<span class="title class_">Web3Provider</span>(ethereum, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(provider);</span><br><span class="line">        <span class="keyword">const</span> signer = provider.<span class="title function_">getSigner</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(signer)</span><br><span class="line">        <span class="keyword">const</span> buyMeACoffee = <span class="keyword">new</span> ethers.<span class="title class_">Contract</span>(</span><br><span class="line">          contractAddress,</span><br><span class="line">          contractABI,</span><br><span class="line">          signer</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;buying coffee..&quot;</span>)</span><br><span class="line">        <span class="keyword">const</span> coffeeTxn = <span class="keyword">await</span> buyMeACoffee.<span class="title function_">buyCoffee</span>(</span><br><span class="line">          name ? name : <span class="string">&quot;anon&quot;</span>,</span><br><span class="line">          message ? message : <span class="string">&quot;Enjoy your coffee!&quot;</span>,</span><br><span class="line">          &#123;<span class="attr">value</span>: ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;0.001&quot;</span>)&#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> coffeeTxn.<span class="title function_">wait</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mined &quot;</span>, coffeeTxn.<span class="property">hash</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;coffee purchased!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clear the form fields.</span></span><br><span class="line">        <span class="title function_">setName</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="title function_">setMessage</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Function to fetch all memos stored on-chain.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getMemos</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; ethereum &#125; = <span class="variable language_">window</span>;</span><br><span class="line">      <span class="keyword">if</span> (ethereum) &#123;</span><br><span class="line">        <span class="keyword">const</span> provider = <span class="keyword">new</span> ethers.<span class="property">providers</span>.<span class="title class_">Web3Provider</span>(ethereum);</span><br><span class="line">        <span class="keyword">const</span> signer = provider.<span class="title function_">getSigner</span>();</span><br><span class="line">        <span class="keyword">const</span> buyMeACoffee = <span class="keyword">new</span> ethers.<span class="title class_">Contract</span>(</span><br><span class="line">          contractAddress,</span><br><span class="line">          contractABI,</span><br><span class="line">          signer</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fetching memos from the blockchain..&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> memos = <span class="keyword">await</span> buyMeACoffee.<span class="title function_">getMemos</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fetched!&quot;</span>);</span><br><span class="line">        <span class="title function_">setMemos</span>(memos);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Metamask is not connected&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> buyMeACoffee;</span><br><span class="line">    <span class="title function_">isWalletConnected</span>();</span><br><span class="line">    <span class="title function_">getMemos</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create an event handler function for when someone sends</span></span><br><span class="line">    <span class="comment">// us a new memo.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onNewMemo</span> = (<span class="params"><span class="keyword">from</span>, timestamp, name, message</span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Memo received: &quot;</span>, <span class="keyword">from</span>, timestamp, name, message);</span><br><span class="line">      <span class="title function_">setMemos</span>(<span class="function">(<span class="params">prevState</span>) =&gt;</span> [</span><br><span class="line">        ...prevState,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">address</span>: <span class="keyword">from</span>,</span><br><span class="line">          <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(timestamp * <span class="number">1000</span>),</span><br><span class="line">          message,</span><br><span class="line">          name</span><br><span class="line">        &#125;</span><br><span class="line">      ]);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;ethereum&#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Listen for new memo events.</span></span><br><span class="line">    <span class="keyword">if</span> (ethereum) &#123;</span><br><span class="line">      <span class="keyword">const</span> provider = <span class="keyword">new</span> ethers.<span class="property">providers</span>.<span class="title class_">Web3Provider</span>(ethereum, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">      <span class="keyword">const</span> signer = provider.<span class="title function_">getSigner</span>();</span><br><span class="line">      buyMeACoffee = <span class="keyword">new</span> ethers.<span class="title class_">Contract</span>(</span><br><span class="line">        contractAddress,</span><br><span class="line">        contractABI,</span><br><span class="line">        signer</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      buyMeACoffee.<span class="title function_">on</span>(<span class="string">&quot;NewMemo&quot;</span>, onNewMemo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (buyMeACoffee) &#123;</span><br><span class="line">        buyMeACoffee.<span class="title function_">off</span>(<span class="string">&quot;NewMemo&quot;</span>, onNewMemo);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, []);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Buy Albert a Coffee!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">content</span>=<span class="string">&quot;Tipping site&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/favicon.ico&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">main</span> <span class="attr">className</span>=<span class="string">&#123;styles.main&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">className</span>=<span class="string">&#123;styles.title&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          Buy Albert a Coffee!</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        </span></span><br><span class="line"><span class="language-xml">        &#123;currentAccount ? (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                  Name</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                </span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">id</span>=<span class="string">&quot;name&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">placeholder</span>=<span class="string">&quot;anon&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">onChange</span>=<span class="string">&#123;onNameChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                  Send Albert a message</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">textarea</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">rows</span>=<span class="string">&#123;3&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">placeholder</span>=<span class="string">&quot;Enjoy your coffee!&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">id</span>=<span class="string">&quot;message&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">onChange</span>=<span class="string">&#123;onMessageChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">required</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">type</span>=<span class="string">&quot;button&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">onClick</span>=<span class="string">&#123;buyCoffee&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                  Send 1 Coffee for 0.001ETH</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ) : (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;connectWallet&#125;</span>&gt;</span> Connect your wallet <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        )&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;currentAccount &amp;&amp; (<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Memos received<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>)&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;currentAccount &amp;&amp; (memos.map((memo, idx) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">        return (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">&#123;idx&#125;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;border:</span>&quot;<span class="attr">2px</span> <span class="attr">solid</span>&quot;, &quot;<span class="attr">borderRadius</span>&quot;<span class="attr">:</span>&quot;<span class="attr">5px</span>&quot;, <span class="attr">padding:</span> &quot;<span class="attr">5px</span>&quot;, <span class="attr">margin:</span> &quot;<span class="attr">5px</span>&quot;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span>&quot;<span class="attr">fontWeight</span>&quot;<span class="attr">:</span>&quot;<span class="attr">bold</span>&quot;&#125;&#125;&gt;</span>&quot;&#123;memo.message&#125;&quot;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>From: &#123;memo.name&#125; at &#123;memo.timestamp.toString()&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        )</span></span><br><span class="line"><span class="language-xml">      &#125;))&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">footer</span> <span class="attr">className</span>=<span class="string">&#123;styles.footer&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">a</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">href</span>=<span class="string">&quot;https://alchemy.com/?a=roadtoweb3weektwo&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">rel</span>=<span class="string">&quot;noopener noreferrer&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">          Created by @thatguyintech for Alchemy&#x27;s Road to Web3 lesson two!</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>首先注意这是浏览器环境，所以获取 provider 和刚才的 node 有所不同。</p>
<p>其次这里涉及到了链接钱包，获取钱包的签名者，获取钱包的 provider，合约实例生成（3 个参数），合约函数调用。有些和 node 那边不一样，有些是一样的。</p>
<h3 id="我再提供一个-node-环境的脚本文件，主要用来回收资金"><a href="#我再提供一个-node-环境的脚本文件，主要用来回收资金" class="headerlink" title="我再提供一个 node 环境的脚本文件，主要用来回收资金"></a>我再提供一个 node 环境的脚本文件，主要用来回收资金</h3><div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// scripts/withdraw.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hre = <span class="built_in">require</span>(<span class="string">&quot;hardhat&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> abi = <span class="built_in">require</span>(<span class="string">&quot;../artifacts/contracts/BuyMeACoffee.sol/BuyMeACoffee.json&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBalance</span>(<span class="params">provider, address</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> balanceBigInt = <span class="keyword">await</span> provider.<span class="title function_">getBalance</span>(address);</span><br><span class="line">  <span class="keyword">return</span> hre.<span class="property">ethers</span>.<span class="property">utils</span>.<span class="title function_">formatEther</span>(balanceBigInt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Get the contract that has been deployed to Goerli.</span></span><br><span class="line">  <span class="keyword">const</span> contractAddress=<span class="string">&quot;0xDBa03676a2fBb6711CB652beF5B7416A53c1421D&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> contractABI = abi.<span class="property">abi</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the node connection and wallet connection.</span></span><br><span class="line">  <span class="keyword">const</span> provider = <span class="keyword">new</span> hre.<span class="property">ethers</span>.<span class="property">providers</span>.<span class="title class_">JsonRpcProvider</span>(<span class="string">&quot;goerli&quot;</span>, process.<span class="property">env</span>.<span class="property">GOERLI_API_KEY</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ensure that signer is the SAME address as the original contract deployer,</span></span><br><span class="line">  <span class="comment">// or else this script will fail with an error.</span></span><br><span class="line">  <span class="keyword">const</span> signer = <span class="keyword">new</span> hre.<span class="property">ethers</span>.<span class="title class_">Wallet</span>(process.<span class="property">env</span>.<span class="property">PRIVATE_KEY</span>, provider);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Instantiate connected contract.</span></span><br><span class="line">  <span class="keyword">const</span> buyMeACoffee = <span class="keyword">new</span> hre.<span class="property">ethers</span>.<span class="title class_">Contract</span>(contractAddress, contractABI, signer);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check starting balances.</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;current balance of owner: &quot;</span>, <span class="keyword">await</span> <span class="title function_">getBalance</span>(provider, signer.<span class="property">address</span>), <span class="string">&quot;ETH&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> contractBalance = <span class="keyword">await</span> <span class="title function_">getBalance</span>(provider, buyMeACoffee.<span class="property">address</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;current balance of contract: &quot;</span>, <span class="keyword">await</span> <span class="title function_">getBalance</span>(provider, buyMeACoffee.<span class="property">address</span>), <span class="string">&quot;ETH&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Withdraw funds if there are funds to withdraw.</span></span><br><span class="line">  <span class="keyword">if</span> (contractBalance !== <span class="string">&quot;0.0&quot;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;withdrawing funds..&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> withdrawTxn = <span class="keyword">await</span> buyMeACoffee.<span class="title function_">withdrawTips</span>();</span><br><span class="line">    <span class="keyword">await</span> withdrawTxn.<span class="title function_">wait</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;no funds to withdraw!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check ending balance.</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;current balance of owner: &quot;</span>, <span class="keyword">await</span> <span class="title function_">getBalance</span>(provider, signer.<span class="property">address</span>), <span class="string">&quot;ETH&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We recommend this pattern to be able to use async/await everywhere</span></span><br><span class="line"><span class="comment">// and properly handle errors.</span></span><br><span class="line"><span class="title function_">main</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> process.<span class="title function_">exit</span>(<span class="number">0</span>))</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></div>


<h3 id="比较（重要）"><a href="#比较（重要）" class="headerlink" title="比较（重要）"></a>比较（重要）</h3><table>
<thead>
<tr>
<th>特性</th>
<th>第一段代码（<code>withdraw.js</code>）</th>
<th>第二段代码（<code>Web3Provider</code>）</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>运行环境</strong></td>
<td>Node.js + Hardhat</td>
<td>浏览器 + MetaMask</td>
<td></td>
</tr>
<tr>
<td><strong>Provider 类型</strong></td>
<td><code>JsonRpcProvider</code></td>
<td><code>Web3Provider</code></td>
<td></td>
</tr>
<tr>
<td><strong>签名者来源</strong></td>
<td>环境变量中的私钥</td>
<td>用户通过 MetaMask 签署</td>
<td></td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>后端脚本，自动化操作（如提取资金、批量交易）</td>
<td>前端交互，用户发起交易（如支付、操作合约）</td>
<td></td>
</tr>
<tr>
<td><strong>与区块链交互</strong></td>
<td>独立连接节点，通过私钥签名</td>
<td>依赖浏览器钱包，通过用户确认并签名</td>
<td>****</td>
</tr>
</tbody></table>
]]></content>
  </entry>
  <entry>
    <title>el-select 顶部固定显示滚动到的项目的group分组</title>
    <url>/myBlog/2024/12/25/el-select-%E9%A1%B6%E9%83%A8%E5%9B%BA%E5%AE%9A%E6%98%BE%E7%A4%BA%E6%BB%9A%E5%8A%A8%E5%88%B0%E7%9A%84%E9%A1%B9%E7%9B%AE%E7%9A%84group%E5%88%86%E7%BB%84/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>项目需要实现一个下拉框，除了需要对选项分组，还需要在头部展示当前滚动位置的分组信息，因为第一行数据处在“其他”，所以显示“其他”。效果如下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241120152911.png"
                     
                ></p>
<p>由于 element-ui 并没有相关的使用案例，所以就自己手搓一个实现。里面涉及到的 dom 操作是我以前很少接触的，所以记录一下。</p>
<h2 id="功能拆分"><a href="#功能拆分" class="headerlink" title="功能拆分"></a>功能拆分</h2><p>由于数据量比较大，需要提前获取数据，组合成分组 option 的数据格式。</p>
<p>并且需要一个筛选方法，对展示的左右两侧数据都有响应。</p>
<p>官方提供了一个 header 插槽，但是难点在于如何绑定当前滚动到的 option 的分组信息到插槽里呢。这里就涉及到 vue 的 dom 操作。</p>
<h2 id="获取-dom"><a href="#获取-dom" class="headerlink" title="获取 dom"></a>获取 dom</h2><p>首先我需要获取 selectRef，在 vue 3 组件式 APi 中，这是一个组件实例。他并不是一个 dom 对象。组件实例上有许多当前组件的属性和方法，也有一些带着 $符号的 vue 提供的属性，其中 $el 就是获取当前组件实例 dom 对象的属性。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241120154336.png"
                     
                ></p>
<p>经过查阅资料，其中的 popperRef 属性提供了下拉框的 dom，并且通过在页面观察滚动所在 div，我们可以获取到滚动层的 dom 节点，并添加事件监听。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">watchScroll</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> popperRef = selectRef.<span class="property">value</span>?.<span class="property">popperRef</span>; <span class="comment">// 获取下拉框 DOM</span></span><br><span class="line">    <span class="keyword">if</span> (popperRef) &#123;</span><br><span class="line">      <span class="keyword">const</span> scrollContainer = popperRef.<span class="title function_">querySelector</span>(<span class="string">&#x27;.ep-scrollbar__wrap&#x27;</span>);</span><br><span class="line">      scrollContainer.<span class="title function_">addEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>, onScroll);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>


<p>我们获取滚动 div 到下拉框顶部的距离，然后需要比较每一个 option 到顶部的距离，找到相同的那个 option，就可以知道位于下拉框第一个的 option 的 dom。获取他的内容就可以知道他的分组信息，并且绑定到一个响应式变量上，实现动态渲染。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onScroll</span> = (<span class="params">event</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> scrollTop = event.<span class="property">target</span>.<span class="property">scrollTop</span>;</span><br><span class="line">  <span class="keyword">const</span> groupElements = event.<span class="property">target</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.ep-select-group__wrap&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> visibleDomain = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  groupElements.<span class="title function_">forEach</span>(<span class="function">(<span class="params">group</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; offsetTop, clientHeight &#125; = group;</span><br><span class="line">    <span class="keyword">if</span> (scrollTop &gt;= offsetTop &amp;&amp; scrollTop &lt; offsetTop + clientHeight) &#123;</span><br><span class="line">      visibleDomain = group.<span class="title function_">querySelector</span>(<span class="string">&#x27;.ep-select-group__title&#x27;</span>)?.<span class="property">textContent</span>?.<span class="title function_">trim</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  currentDomain.<span class="property">value</span> = visibleDomain || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>包括上述功能的完整代码如下</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-select</span><br><span class="line">    ref=&quot;selectRef&quot;</span><br><span class="line">    v-model=&quot;projectName&quot;</span><br><span class="line">    placeholder=&quot;Select&quot;</span><br><span class="line">    size=&quot;default&quot;</span><br><span class="line">    style=&quot;width: 240px&quot;</span><br><span class="line">    filterable</span><br><span class="line">    :filter-method=&quot;filter&quot;</span><br><span class="line">    clearable</span><br><span class="line">    :loading=&quot;loading&quot;</span><br><span class="line">  &gt;</span><br><span class="line">    &lt;template #header&gt;</span><br><span class="line">      &lt;div style=&quot;font-size: var(--ep-font-size-base); color:var(--ep-text-color-regular); font-weight: 800;&quot;&gt;</span><br><span class="line">        数据域  : &#123;&#123; currentDomain &#125;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">    &lt;el-option-group</span><br><span class="line">      v-for=&quot;group in options&quot;</span><br><span class="line">      :key=&quot;group.label&quot;</span><br><span class="line">      :label=&quot;group.label&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;el-option</span><br><span class="line">        v-for=&quot;item in group.options&quot;</span><br><span class="line">        :key=&quot;item.value&quot;</span><br><span class="line">        :label=&quot;item.label&quot;</span><br><span class="line">        :value=&quot;item.value&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;span style=&quot;float: left&quot;&gt;&#123;&#123; item.label &#125;&#125;&lt;/span&gt;</span><br><span class="line">        &lt;span</span><br><span class="line">          style=&quot;</span><br><span class="line">          float: right;</span><br><span class="line">          color: var(--el-text-color-secondary);</span><br><span class="line">          font-size: 13px;</span><br><span class="line">        &quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &#123;&#123; item.projectEname &#125;&#125;</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">      &lt;/el-option&gt;</span><br><span class="line">    &lt;/el-option-group&gt;</span><br><span class="line">  &lt;/el-select&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">//远程查询的select</span><br><span class="line">import &#123; EiInfo &#125; from &#x27;@/utils/eiinfo.js&#x27;;</span><br><span class="line">import myApi from &#x27;@/api/index.js/&#x27;;</span><br><span class="line"></span><br><span class="line">const projectName = defineModel()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const originalOptions = ref([]); // 用于存储原始数据</span><br><span class="line">//筛选后的工作空间列表</span><br><span class="line">const options = ref([]);</span><br><span class="line">const loading = ref(false);</span><br><span class="line">const currentDomain = ref(&quot;&quot;); // 当前滚动可见的分组</span><br><span class="line">const selectRef = ref(null); // el-select 的引用</span><br><span class="line"></span><br><span class="line">//挂载后加载工作空间</span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">      loadProjectInfo();</span><br><span class="line">      watchScroll();</span><br><span class="line">    &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">//每次option变化，初始的数据域都是第一个option的group</span><br><span class="line">watch(options,()=&gt;&#123;</span><br><span class="line">  currentDomain.value = options.value[0].label</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const watchScroll = () =&gt; &#123;</span><br><span class="line">  nextTick(() =&gt; &#123;</span><br><span class="line">    const popperRef = selectRef.value?.popperRef; // 获取下拉框 DOM</span><br><span class="line">    if (popperRef) &#123;</span><br><span class="line">      const scrollContainer = popperRef.querySelector(&#x27;.ep-scrollbar__wrap&#x27;);</span><br><span class="line">      scrollContainer.addEventListener(&#x27;scroll&#x27;, onScroll);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const onScroll = (event) =&gt; &#123;</span><br><span class="line">  const scrollTop = event.target.scrollTop;</span><br><span class="line">  const groupElements = event.target.querySelectorAll(&#x27;.ep-select-group__wrap&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  let visibleDomain = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">  groupElements.forEach((group) =&gt; &#123;</span><br><span class="line">    const &#123; offsetTop, clientHeight &#125; = group;</span><br><span class="line">    if (scrollTop &gt;= offsetTop &amp;&amp; scrollTop &lt; offsetTop + clientHeight) &#123;</span><br><span class="line">      visibleDomain = group.querySelector(&#x27;.ep-select-group__title&#x27;)?.textContent?.trim();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  currentDomain.value = visibleDomain || &quot;&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const filter = (query) =&gt; &#123;</span><br><span class="line">  if (loading.value) return;</span><br><span class="line"></span><br><span class="line">  loading.value = true;</span><br><span class="line"></span><br><span class="line">  // 如果有查询条件，基于原始数据进行筛选</span><br><span class="line">  if (query) &#123;</span><br><span class="line">    const lowerQuery = query.toLowerCase();</span><br><span class="line"></span><br><span class="line">    // 过滤分组和分组内的项目</span><br><span class="line">    options.value = originalOptions.value</span><br><span class="line">      .map((group) =&gt; &#123;</span><br><span class="line">        const filteredItems = group.options.filter((item) =&gt; &#123;</span><br><span class="line">          return (</span><br><span class="line">            item.label.toLowerCase().includes(lowerQuery) ||</span><br><span class="line">            item.projectEname.toLowerCase().includes(lowerQuery)</span><br><span class="line">          );</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 如果当前分组有匹配项，保留分组</span><br><span class="line">        return filteredItems.length &gt; 0</span><br><span class="line">          ? &#123; ...group, options: filteredItems &#125;</span><br><span class="line">          : null; // 如果没有匹配项，返回 null</span><br><span class="line">      &#125;)</span><br><span class="line">      .filter(Boolean); // 去掉 null 的分组</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 如果没有查询条件，恢复为原始数据</span><br><span class="line">    options.value = [...originalOptions.value];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  loading.value = false;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const loadProjectInfo = () =&gt; &#123;</span><br><span class="line">  loading.value = true;</span><br><span class="line">  const projectList = []</span><br><span class="line">  const queryInfo = new EiInfo();</span><br><span class="line">  queryInfo.set(&quot;isGroup&quot;,true)</span><br><span class="line">  myApi.getProjectInfo(queryInfo).then(res =&gt; &#123;</span><br><span class="line">    const resBlock = res.getBlock(&#x27;result&#x27;);</span><br><span class="line">    for (let i = 0; i &lt; resBlock.rows.length; i++) &#123;</span><br><span class="line">      let domain = resBlock.getCell(i,&quot;domain&quot;)</span><br><span class="line">      let value = resBlock.getCell(i, &#x27;projectName&#x27;);</span><br><span class="line">      let label = resBlock.getCell(i, &#x27;projectAlias&#x27;);</span><br><span class="line">      let projectEname = resBlock.getCell(i, &#x27;projectEname&#x27;)</span><br><span class="line">      projectList.push(&#123;</span><br><span class="line">        value: value,</span><br><span class="line">        label: label,</span><br><span class="line">        projectEname:projectEname,</span><br><span class="line">        domain:domain</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    options.value = sortByVariable(projectList,&quot;domain&quot;)</span><br><span class="line">    originalOptions.value = options.value</span><br><span class="line">    loading.value = false;</span><br><span class="line">    if (options.value.length &gt; 0) &#123;</span><br><span class="line">      projectName.value = options.value[0].options[0].value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const sortByVariable = (_list, _val) =&gt; &#123;</span><br><span class="line">  const result = []; // 用于存放分组后的数据</span><br><span class="line">  const groupMap = new Map(); // 使用 Map 提高性能</span><br><span class="line"></span><br><span class="line">  _list.forEach((item) =&gt; &#123;</span><br><span class="line">    const key = item[_val];</span><br><span class="line">    if (!groupMap.has(key)) &#123;</span><br><span class="line">      groupMap.set(key, []); // 初始化分组</span><br><span class="line">      result.push(&#123;</span><br><span class="line">        label: key,</span><br><span class="line">        options: groupMap.get(key),</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    groupMap.get(key).push(item); // 将当前项加入对应分组</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  return result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.stick-group&#123;</span><br><span class="line">  position: fixed;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></div>


<h2 id="优化空间"><a href="#优化空间" class="headerlink" title="优化空间"></a>优化空间</h2><ul>
<li>数据量大，获取数据到整合成特定结构耗时长</li>
<li>在滚动的时候频繁地渲染</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>solidity入门学习</title>
    <url>/myBlog/2024/12/25/solidity%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link"   href="https://solidity-by-example.org/variables/" >solidity by example<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h2><h3 id="Variable-Type"><a href="#Variable-Type" class="headerlink" title="Variable Type"></a>Variable Type</h3><p>Local  state  globel </p>
<p>[[solidity内置方法]]</p>
<h3 id="Constant-vs-immutable"><a href="#Constant-vs-immutable" class="headerlink" title="Constant vs immutable"></a>Constant vs immutable</h3><ul>
<li>Constant value is  fixed and stored in the contract’s bytecode.</li>
<li>Immutable value is assigned dynamically during contract deployment ,in constructor ,and remains fixed afterward.</li>
</ul>
<p>Both Improve gas efficiency.</p>
<h3 id="Primitive"><a href="#Primitive" class="headerlink" title="Primitive"></a>Primitive</h3><p>uint256，bool, address, bytes</p>
<h3 id="Data-Locations"><a href="#Data-Locations" class="headerlink" title="Data Locations"></a>Data Locations</h3><p>Storeage, memory, calldata</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//不能直接在 `storage` 类型的局部变量中使用 `new` 或通过值初始化来创建一个新的 `MyStruct` 实例。`storage` 是引用类型，意味着它必须引用合约状态中的数据（如映射或数组中的元素），而不能是一个新的内存中的结构体。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>) public &#123;</span><br><span class="line">    <span class="comment">// call _f with state variables</span></span><br><span class="line">    <span class="title function_">_f</span>(arr, map, myStructs[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get a struct from a mapping</span></span><br><span class="line">    <span class="title class_">MyStruct</span> storage myStruct = myStructs[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// create a struct in memory</span></span><br><span class="line">    <span class="title class_">MyStruct</span> memory myMemStruct = <span class="title class_">MyStruct</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>Internal 和 private 的函数的入参和返回值可以是 storage，但是其余的只能是 memory 或者 calldata，因为这些会被外部的调用，我们不能让外面这些调用者改变我内部的状态。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>) public &#123;</span><br><span class="line"></span><br><span class="line">	<span class="title class_">MyStruct</span> storage myStruct = myStructs[<span class="number">1</span>];</span><br><span class="line">	<span class="title class_">MyStruct</span> memory myStruct2 = myStructs[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// call _f with state variables</span></span><br><span class="line">    <span class="title function_">_f</span>(arr, map, myStruct,myStruct2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_f</span>(<span class="params"></span></span><br><span class="line"><span class="params">    uint256[] storage _arr,</span></span><br><span class="line"><span class="params">    mapping(uint256 =&gt; address) storage _map,</span></span><br><span class="line"><span class="params">    MyStruct memory _myStruct,</span></span><br><span class="line"><span class="params">    MyStruct storage _myStruct2</span></span><br><span class="line"><span class="params"></span>) internal &#123;</span><br><span class="line">    _myStruct.<span class="property">foo</span> += <span class="number">1</span>;</span><br><span class="line">    _myStruct2.<span class="property">foo</span> += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>Memory 不会修改传入的参数的值，但是 storage 的参数会被函数里面的逻辑修改。</p>
<p>同时，我们可以把一个 storage 赋值给 memory，相当于创建了一个复制版本</p>
<p><em>默认值</em></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241211230810.png"
                     
                ></p>
<h3 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h3><p>Mapping 不支持 memory，所以不支持作为参数传入，也不支持遍历，这和 js 的 map 有所不同</p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="Destructuring-assignment"><a href="#Destructuring-assignment" class="headerlink" title="Destructuring assignment"></a>Destructuring assignment</h3><div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">destructuringAssignments</span>(<span class="params"></span>)</span><br><span class="line">    public</span><br><span class="line">    pure</span><br><span class="line">    <span class="title function_">returns</span> (uint256, bool, uint256, uint256, uint256)</span><br><span class="line">&#123;</span><br><span class="line">    (uint256 i, bool b, uint256 j) = <span class="title function_">returnMany</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Values can be left out.</span></span><br><span class="line">    (uint256 x,, uint256 y) = (<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (i, b, j, x, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>解构元组，解构赋值，并且返回元组。</p>
<h3 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h3><p>可以返回元组，并且解构赋值别的函数的返回的元组。</p>
<p>返回的基本类型无所谓，基本类型不需要定义 location。<br>返回如果是动态类型，那么就应该是memory，不能返回一个 storage。因为它们是引用类型，并且可能会引发副作用，也会造成数据泄露。</p>
<h3 id="修饰词"><a href="#修饰词" class="headerlink" title="修饰词"></a>修饰词</h3><ul>
<li>Pure, declares that no state variable will be changed or read.</li>
<li>View, declares that no state will be changed.</li>
</ul>
<h3 id="Modifire"><a href="#Modifire" class="headerlink" title="Modifire"></a>Modifire</h3><p>Modifiers are code that can be run before and &#x2F; or after a function call.</p>
<p>修饰符将验证逻辑与函数主体分离，提高代码可读性和可维护性。防止重入攻击。</p>
<h2 id="Visibility"><a href="#Visibility" class="headerlink" title="Visibility"></a>Visibility</h2><p><em>Functions and state variables</em> have to declare whether they are accessible by other contracts.</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241211223345.png"
                     
                ></p>
<h2 id="Constructor"><a href="#Constructor" class="headerlink" title="Constructor"></a>Constructor</h2><p>Two ways to initialize parent contract with parameters</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Pass the parameters here in the inheritance list.</span></span><br><span class="line">contract B is <span class="title function_">X</span>(<span class="string">&quot;Input to X&quot;</span>), <span class="title function_">Y</span>(<span class="params"><span class="string">&quot;Input to Y&quot;</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">contract C is X, Y &#123;</span><br><span class="line">    <span class="comment">// Pass the parameters here in the constructor,</span></span><br><span class="line">    <span class="comment">// similar to function modifiers.</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">string memory _name, string memory _text</span>) <span class="title function_">X</span>(_name) <span class="title function_">Y</span>(<span class="params">_text</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h2><p>An error will undo all changes made to the state during a transaction.</p>
<p>Require should be used to validate conditions such as</p>
<ul>
<li>inputs  </li>
<li>conditions before execution</li>
<li>return values from calls to other functions</li>
</ul>
<h2 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h2><p><code>Events</code> allow logging to the Ethereum blockchain. Is a cheap form of storage。</p>
<p>日志被存储在该交易发生的区块里而不是合约的状态变量里，所以日志不能被这个发出的合约监测，但可以被监测区块的人监测到。</p>
<p>事件参数分为两种参数：indexed and non-indexed，区别在于有没有放进 topics 栏位。<br>事件最多允许三个参数被索引，其他没有索引的参数将会被一起编码并放到 data 里去。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.26</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">Event</span> &#123;</span><br><span class="line">    <span class="comment">// Event declaration</span></span><br><span class="line">    <span class="comment">// Up to 3 parameters can be indexed.</span></span><br><span class="line">    <span class="comment">// Indexed parameters helps you filter the logs by the indexed parameter</span></span><br><span class="line">    event <span class="title class_">Log</span>(address indexed sender, string message);</span><br><span class="line">    event <span class="title class_">AnotherLog</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) public &#123;</span><br><span class="line">        emit <span class="title class_">Log</span>(msg.<span class="property">sender</span>, <span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">        emit <span class="title class_">Log</span>(msg.<span class="property">sender</span>, <span class="string">&quot;Hello EVM!&quot;</span>);</span><br><span class="line">        emit <span class="title class_">AnotherLog</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>交易的日志部分</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241224220756.png"
                     
                ></p>
<h2 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h2><p>满足合约的交互需求</p>
<p>你可以在合约中声明接口，然后用该接口来定义如何调用其他合约的函数。合约 A 通过接口与合约 B 交互时，只需要知道接口的签名，而不需要了解 B 合约的具体实现。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line">contract A &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">incrementCounter</span>(<span class="params">address _counter</span>) external &#123;</span><br><span class="line">        <span class="title class_">ICounter</span>(_counter).<span class="title function_">increment</span>();  <span class="comment">// 调用 ICounter 接口中的 increment 方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getCount</span>(<span class="params">address _counter</span>) external view <span class="title function_">returns</span> (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ICounter</span>(_counter).<span class="title function_">count</span>();  <span class="comment">// 调用 ICounter 接口中的 count 方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="Try-catch"><a href="#Try-catch" class="headerlink" title="Try&#x2F;catch"></a>Try&#x2F;catch</h2><p>可以针对外部合约调用和合约创建做异常的捕获，让这些异常不会终止交易的进行，回滚。</p>
]]></content>
  </entry>
  <entry>
    <title>有关provider和链上数据获取</title>
    <url>/myBlog/2024/12/30/post%E6%9C%89%E5%85%B3provider%E5%92%8C%E9%93%BE%E4%B8%8A%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96/</url>
    <content><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><strong>provider</strong> 是一个用于与区块链网络交互的对象，主要负责提供区块链的数据和与智能合约的通信。它是连接你本地应用（如前端、脚本）与区块链节点之间的桥梁。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>拥有自己的节点，这可能需要大量的时间来配置，所以我们会去找第三方的 node provider </p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/../attachment/Pasted%20image%2020241225173327.png"
                     
                ></p>
<p> 这是一个 DApp 架构中特殊的角色，它负责与区块链进行通信，并进行合约的读&#x2F;写操作。他是钱包和区块链的中枢。</p>
<p>可以分为 2 种</p>
<ul>
<li>InjectProvider（web 3 Provider） 主流 metamask</li>
<li>JSON-RPC Provider  主流 Infura achemy</li>
</ul>
<p><em>本地网络的 provider</em></p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> provider = ethers.<span class="property">provider</span>; <span class="comment">// 默认为 Hardhat 网络的provider</span></span><br></pre></td></tr></table></figure></div>

<p><em>以太坊网络的 provider</em>，需要提前在 hardhat 配置里面配置好 rpc 的 api-key，我们通过这个 http 地址就可以实现与远程节点的交互。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取 provider 对象，连接到以太坊网络</span></span><br><span class="line"><span class="keyword">const</span> provider = ethers.<span class="property">provider</span>; <span class="comment">// 默认为 Hardhat 网络，如果使用测试网或主网，需要提供相应的 RPC URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询地址的余额，返回的是 BigNumber 类型</span></span><br><span class="line"><span class="keyword">const</span> balance = <span class="keyword">await</span> provider.<span class="title function_">getBalance</span>(address);</span><br></pre></td></tr></table></figure></div>

<p>另一种写法</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ethers &#125; = <span class="built_in">require</span>(<span class="string">&quot;ethers&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置以太坊网络的 RPC URL，例如 Infura 或 Alchemy 的服务地址</span></span><br><span class="line"><span class="keyword">const</span> provider = <span class="keyword">new</span> ethers.<span class="property">providers</span>.<span class="title class_">JsonRpcProvider</span>(<span class="string">&quot;https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<p><em>Metamask 的 provider</em></p>
<p>Metamask uses Infura in the background to connect to the network. So Metamask is a user interface on top of Infura service.<br>我们只需要在 metamask 中选择默认支持的网（infura 默认支持）或者自主设置 rpc 的自定义网，就可以通过浏览器中已经安装的 <code>ethereum</code> 对象，获取当前的网的 provider，这就不需要我们向上面一样，去 config 里面配置 rpc-url。（相当于使用 metamask 提前设置好，我们提前自定义好的 rpc）</p>
<p>这里提供一个在浏览器环境中的 provider 代码</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;ethereum&#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> provider = <span class="keyword">new</span> ethers.<span class="property">providers</span>.<span class="title class_">Web3Provider</span>(ethereum, <span class="string">&quot;any&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>因为 metamask 是浏览器插件，不支持 node。，如果要在 node 环境中使用 metamask，还是像上面两个方式一样，记录私钥和 rpc-url。</p>
</blockquote>
<p>Ethereum: 这是一个由浏览器环境（如 MetaMask）提供的对象，它代表当前浏览器中与区块链连接的 Web 3 提供者。你通常在浏览器中通过 window. Ethereum 获取这个对象（MetaMask 会注入这个对象）。<br>例如，window. Ethereum 是 MetaMask 提供的一个对象，允许网页与 MetaMask 交互，执行签名、发送交易等操作。<br>“any”: 这是 Web 3 Provider 的第二个参数，指定你想要连接的网络。这里 “any” 表示自动选择当前 ethereum 对象所连接的任何网络（如主网、测试网等）。如果没有特别指定，它会选择 ethereum 对象当前连接的网络。<br>这也就是为什么在选择发送交易前，钱包需要切换到对应的网络上来。</p>
<h2 id="获取以太坊数据"><a href="#获取以太坊数据" class="headerlink" title="获取以太坊数据"></a>获取以太坊数据</h2><h3 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h3><ul>
<li>了解 url，uri，restful 架构，json-rpc 架构。</li>
<li>了解 web service</li>
</ul>
<h4 id="Web-service"><a href="#Web-service" class="headerlink" title="Web service"></a>Web service</h4><p>A web service is a way to share data with two seperate systems. It can be the same called web api.<br>It open contains many protocal like<br>应用层协议	HTTP&#x2F;HTTPS, WebSocket, gRPC, CoAP，HTTP&#x2F;2	主要用于客户端和服务器之间的通信。<br>数据格式协议	JSON-RPC, SOAP, Protocol Buffers	定义数据的序列化格式和消息传递方式。<br>传输协议	TCP, UDP, QUIC	提供底层数据传输支持。<br>特定场景协议	GraphQL, MQTT, OData, SSE	为特定需求（如实时通信、数据查询）设计的协议。</p>
<p>我们可以着重看一下应用层 HTTP&#x2F;HTTPS, 数据格式 JSON-RPC。</p>
<h4 id="资源获取"><a href="#资源获取" class="headerlink" title="资源获取"></a>资源获取</h4><p>Web 中资源是很重要的概念，我们需要能够定位互联网上的资源，一种是 uri，一种是 url。</p>
<p><em>Url</em> 是基于 http 协议的。比如 <code>https://example.com/api/data</code><br><em>Uri</em> 则是 url 的父级，除了 url 他还包括<br>文本：<code>file:///C:/Users/Username/Documents/file.txt</code><br>图片数据, 将数据内嵌进去: <code>data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUA...</code><br>相对 url： 相对路径。</p>
<h4 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h4><p>Reference:<a class="link"   href="https://stackoverflow.com/questions/50394931/what-is-difference-between-json-rpc-and-json-api" >https://stackoverflow.com/questions/50394931/what-is-difference-between-json-rpc-and-json-api<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>除了资源的获取，我们通常还需要调用服务端写好的方法。这个时候我们一般有几种调用方式</p>
<p> <em>json-rpc 数据结构</em>，使用 json 来调用获取结果，他是用来方法调用返回 json 的，但如果我们想获取资源，我们可以在 result 中放资源的 uri 或者资源本身，只是不建议这么做。<br>他只是远程过程调用规范，他与传输无关，你可以像非常常见的那样在 HTTP 上运行它，你也可以使用它在套接字上运行，或者使用任何其他你认为合适的传输方式</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;getPageHtml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="string">&quot;home&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">返回</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Home Page&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome to the Home Page&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>


<p><em>Restful 风格 api</em> ，与 Json-Rpc 不同，它需要你在 HTTP 服务器上托管。你不能通过它在客户端调用函数。你不能使用非 HTTP 传输协议运行它。作为基于 REST 的规范，它在提供资源信息方面表现出色。如果你想使用一个基于创建、读取、更新、删除某些资源集合的 API，那么这可能是一个不错的选择。<br>也就是他可以通过方法来获取资源<br>并且 REST 使用资源路径（URL）来标识资源，例如：&#x2F;users&#x2F;123 可以直观地表示某个用户的资源。<br>这种设计方式使得 REST 的 API 更易于理解和直观。例如，通过浏览器直接访问 <a class="link"   href="https://example.com/users/123%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%BD%BB%E6%9D%BE%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E5%86%85%E5%AE%B9" >https://example.com/users/123，可以轻松获取资源内容<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>他俩平常都是在 http 协议上运行的，通过 http 的方式来获取数据。</p>
<h3 id="Service-模块"><a href="#Service-模块" class="headerlink" title="Service 模块"></a>Service 模块</h3><p>很多节点比如 infura，alchemy 都可以用 web api 来让 Dapp ,wallet 获取区块链的数据。这里我将介绍 infura 节点。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/../attachment/Pasted%20image%2020241230145917.png"
                     
                ></p>
<p>Infura 提供 json-rpc 和 restful 两种方式来访问网络数据。并且底下列出了支持的网络。不是所有网络都被节点兼容。左边是接口的说明和支持的网络。这些接口两种风格。</p>
<p>Restful ：<code>https://gas.api.infura.io/v3/$&#123;process.env.INFURA_API_KEY&#125;/networks/$&#123;chainId&#125;/suggestedGasFees</code></p>
<p>Json-rpc: <code>https://mainnet.infura.io.infura.io/v3/&lt;YOUR-API-KEY&gt;</code></p>
<p>拿 ethereum 的数据获取举例，我们可以通过 axios，fetch 来获取，通过输入 url，传递的 json 实现。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/../attachment/Pasted%20image%2020241230150117.png"
                     
                ></p>
<p>同时可以用 ether. Js 第三方库，用他们封装好的 provider 来做数据的获取。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/../attachment/Pasted%20image%2020241230150408.png"
                     
                ></p>
<p>由于我们是获取数据，我们可以调用 <code>eth_call</code> 的方法，用于调用智能合约的“只读”函数（即不更改区块链状态的函数）。它允许你查询智能合约的状态或读取数据，但不会消耗 gas 费用，因为它不会触发区块链上的交易。</p>
<h3 id="使用-json-rpc-和链上合约交互"><a href="#使用-json-rpc-和链上合约交互" class="headerlink" title="使用 json-rpc 和链上合约交互"></a>使用 json-rpc 和链上合约交互</h3><div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> baseUrl = <span class="string">&#x27;https://mainnet.infura.io/v3/1fbfb41663cb4efe83ddcd36082586d0&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  <span class="attr">jsonrpc</span>: <span class="string">&#x27;2.0&#x27;</span>,</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;eth_call&#x27;</span>,</span><br><span class="line">  <span class="attr">params</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">to</span>: collection,</span><br><span class="line">      <span class="attr">data</span>: <span class="string">&quot;0x8da5cb5b&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(baseUrl, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!res.<span class="property">ok</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Failed to fetch NFTs&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsonData = <span class="keyword">await</span> res.<span class="title function_">json</span>();</span><br></pre></td></tr></table></figure></div>

<p>这是最原始的方法，通过直接用 eth. Call 方法，调用智能合约的方法。</p>
<p><em>我们可以通过 json-rpc 和以太坊的节点交互，但是和合约交互，我们必须有合约的 abi，并写在 json 里</em><br>Data 就是智能合约方法签名和编码参数的哈希值。参见以太坊合约 ABI 规范。<a class="link"   href="https://docs.soliditylang.org/en/latest/abi-spec.html" >Ethereum contract ABI specification<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>.</p>
<p>我这里写的是一个 owner () 的方法，可以在 etherscan 看到想要测试的合约方法并且获得方法的 hash。</p>
<h4 id="第三方库"><a href="#第三方库" class="headerlink" title="第三方库"></a>第三方库</h4><p>当然我们也可以使用封装好的 ether, webjs 等第三方库。他们的使用方法有所不同。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">&quot;node-fetch&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Web3</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;web3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> web3 = <span class="keyword">new</span> <span class="title class_">Web3</span>(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Web3</span>.<span class="property">providers</span>.<span class="title class_">HttpProvider</span>(<span class="string">&quot;https://mainnet.infura.io/v3/&lt;YOUR-API-KEY&gt;&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tokenURIABI = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">inputs</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">internalType</span>: <span class="string">&quot;uint256&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;tokenId&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;uint256&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;tokenURI&quot;</span>,</span><br><span class="line">    <span class="attr">outputs</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">internalType</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">stateMutability</span>: <span class="string">&quot;view&quot;</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tokenContract = <span class="string">&quot;0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d&quot;</span> <span class="comment">// BAYC contract address</span></span><br><span class="line"><span class="keyword">const</span> tokenId = <span class="number">101</span> <span class="comment">// A token we&#x27;d like to retrieve its metadata of</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> contract = <span class="keyword">new</span> web3.<span class="property">eth</span>.<span class="title class_">Contract</span>(tokenURIABI, tokenContract)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getNFTMetadata</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> contract.<span class="property">methods</span>.<span class="title function_">tokenURI</span>(tokenId).<span class="title function_">call</span>()</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result) <span class="comment">// ipfs://QmeSjSinHpPnmXmspMjwiXyN6zS4E9zccariGR3jxcaWtq/101</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ipfsURL = <span class="title function_">addIPFSProxy</span>(result)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(ipfsURL)</span><br><span class="line">  <span class="keyword">const</span> metadata = <span class="keyword">await</span> response.<span class="title function_">json</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(metadata) <span class="comment">// Metadata in JSON</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> image = <span class="title function_">addIPFSProxy</span>(metadata.<span class="property">image</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getNFTMetadata</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addIPFSProxy</span>(<span class="params">ipfsHash</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">URL</span> = <span class="string">&quot;https://&lt;YOUR_SUBDOMAIN&gt;.infura-ipfs.io/ipfs/&quot;</span></span><br><span class="line">  <span class="keyword">const</span> hash = ipfsHash.<span class="title function_">replace</span>(<span class="regexp">/^ipfs?:\/\//</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">  <span class="keyword">const</span> ipfsURL = <span class="variable constant_">URL</span> + hash</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ipfsURL) <span class="comment">// https://&lt;subdomain&gt;.infura-ipfs.io/ipfs/&lt;ipfsHash&gt;</span></span><br><span class="line">  <span class="keyword">return</span> ipfsURL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<h4 id="使用封装好的-api"><a href="#使用封装好的-api" class="headerlink" title="使用封装好的 api"></a>使用封装好的 api</h4><p>我们目前为止用的是原生的 json-rpc api。但我们也可以用集成包装好的 api 完成我们更复杂的内容，我觉得这一方面 alchemy 做的更好，他们提供了更丰富的 restful api 帮我们实现更加复杂的内容。并且他们的开发文档更加详细 </p>
<p>可以参考 <a class="link"   href="https://www.reddit.com/r/ethdev/comments/10dnpxf/infura_or_alchemy_which_is_better/" >infura or alchemy<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>provider on-chain</tag>
      </tags>
  </entry>
  <entry>
    <title>web3重要概念-provider的介绍</title>
    <url>/myBlog/2024/12/25/web3%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5-provider%E7%9A%84%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241225173327.png"
                     
                ></p>
<p> 这是一个 DApp 架构中特殊的角色，它负责与区块链进行通信，并进行合约的读&#x2F;写操作。他是钱包和区块链的中枢。</p>
<p>可以分为 2 种</p>
<ul>
<li>InjectProvider（web3 Provider） 主流 metamask</li>
<li>JSON-RPC Provider  主流 Infura achemy</li>
</ul>
<p><em>本地网络的 provider</em></p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> provider = ethers.<span class="property">provider</span>; <span class="comment">// 默认为 Hardhat 网络的provider</span></span><br></pre></td></tr></table></figure></div>

<p><em>以太坊网络的 provider</em>，需要提前在 hardhat 配置里面配置好 rpc 的 api-key，我们通过这个 http 地址就可以实现与远程节点的交互。</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取 provider 对象，连接到以太坊网络</span></span><br><span class="line"><span class="keyword">const</span> provider = ethers.<span class="property">provider</span>; <span class="comment">// 默认为 Hardhat 网络，如果使用测试网或主网，需要提供相应的 RPC URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询地址的余额，返回的是 BigNumber 类型</span></span><br><span class="line"><span class="keyword">const</span> balance = <span class="keyword">await</span> provider.<span class="title function_">getBalance</span>(address);</span><br></pre></td></tr></table></figure></div>

<p><em>Metamask 的 provider</em></p>
<p>Metamask uses Infura in the background to connect to the network. So Metamask is a user interface on top of Infura service.<br>我们只需要在 metamask 中选择默认支持的网（infura 默认支持）或者自主设置 rpc 的自定义网，就可以通过浏览器中已经安装的 <code>ethereum</code> 对象，获取当前的网的 provider，这就不需要我们向上面一样，去 config 里面配置 rpc-url。（相当于使用 metamask 提前设置好，我们提前自定义好的 rpc）</p>
<p>这里提供一个在浏览器环境中的 provider 代码</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;ethereum&#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> provider = <span class="keyword">new</span> ethers.<span class="property">providers</span>.<span class="title class_">Web3Provider</span>(ethereum, <span class="string">&quot;any&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>因为 metamask 是浏览器插件，不支持 node。，如果要在 node 环境中使用 metamask，还是像上面两个方式一样，记录私钥和 rpc-url。</p>
</blockquote>
<p>Ethereum: 这是一个由浏览器环境（如 MetaMask）提供的对象，它代表当前浏览器中与区块链连接的 Web 3 提供者。你通常在浏览器中通过 window. Ethereum 获取这个对象（MetaMask 会注入这个对象）。<br>例如，window. Ethereum 是 MetaMask 提供的一个对象，允许网页与 MetaMask 交互，执行签名、发送交易等操作。<br>“any”: 这是 Web 3 Provider 的第二个参数，指定你想要连接的网络。这里 “any” 表示自动选择当前 ethereum 对象所连接的任何网络（如主网、测试网等）。如果没有特别指定，它会选择 ethereum 对象当前连接的网络。<br>这也就是为什么在选择发送交易前，钱包需要切换到对应的网络上来。</p>
]]></content>
  </entry>
  <entry>
    <title>关于修改第三方组件遇到的坑</title>
    <url>/myBlog/2024/10/15/%E5%85%B3%E4%BA%8E%E4%BF%AE%E6%94%B9%E7%AC%AC%E4%B8%89%E6%96%B9%E7%BB%84%E4%BB%B6%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该文章解决了针对 vue 的 scoped 情况下的对第三方样式修改问题。<br>介绍了 <code>scoped</code> 的作用<br>介绍了样式穿透的作用<br>总结了三种不同情况修改样式的方法。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>代码遇到 css 样式不生效的问题，部分代码如下</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;el-select </span><br><span class="line">  v-model=&quot;form.poolName&quot; </span><br><span class="line">  placeholder=&quot;请选择资源组&quot; </span><br><span class="line">  style=&quot;width: 100%;&quot;</span><br><span class="line">  popper-class=&quot;custom-dropdown&quot;</span><br><span class="line">&gt;</span><br><span class="line">  &lt;el-option</span><br><span class="line">    v-for=&quot;item in options&quot;</span><br><span class="line">    :key=&quot;item.value&quot;</span><br><span class="line">    :label=&quot;item.label&quot;</span><br><span class="line">    :value=&quot;item.value&quot;</span><br><span class="line">  &gt;&lt;/el-option&gt;</span><br><span class="line">&lt;/el-select&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">	.custom-dropdown &#123;</span><br><span class="line">   width: 400px !important;</span><br><span class="line">   background-color: rgb(226, 21, 21);</span><br><span class="line">   border: 1px solid #ddd;</span><br><span class="line"> &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></div>

<p><code>popper-class</code> 可以对 <code>select</code> 的下拉框部分设置样式，这是 <code>html</code> 原生的 <code>select</code> 无法做到的。但是当我设置 <code>style 为 scoped</code> 的时候，<code>vue</code> 会把这个样式和这个组件绑定在一起，最终编译完呈现如下效果</p>
<p>![[Pasted image 20241015145631.png]]<br>![[Pasted image 20241015145600.png]]</p>
<p>可以看到 <code>el-select</code> 的 <code>class=&quot;custom-dropdown&quot;</code> 加了一个独立属性 <code>data-v</code> ，并且选择器也是自动加上了属性选择变为了类【属性】的形式。<strong>给组件根元素加上特殊属性这就是 <code>scoped</code> 的作用</strong></p>
<p>但是当我希望这个把这个 <code>custom-dropdown</code> 应用到 <code>popper-class=&quot;custom-dropdown&quot;</code> 的时候，就出现问题，因为这个 popper-class 最后编译解析出来是一个普通的类，这个类的元素并没有加上属性。也就导致我写的样式 <code>custom-dropdown</code> 没有被应用上去，最后在开发者工具上找不到这个样式的选择器</p>
<p>![[Pasted image 20241015150028.png]]</p>
<p>他没有被赋予表明是该组件样式的 <code>data-v</code> 所以该样式失效。</p>
<p>一开始我以为是样式穿透问题，但是加了 <code>deep</code>  也没有用，原因是我选中的类所在的组件根本不是我组件的子组件，<code>option</code> 下拉框 自己另开了一片区域。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>![[Pasted image 20241015170751.png]]</p>
<p><code>el-select</code> 和 <code>option</code> 不属于一个组件，<code>option</code> 有一个独立的区域独立于 <code>app</code> 之外，也就是他的样式不受 <code>scoped</code> 的限制，一旦用到 <code>data-v</code> 的选择器（也就是我们在 scope 里面写样式），都选择不到 <code>option</code> 的样式。</p>
<p>最后实现：</p>
<div class="code-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-class">.custom-dropdown</span> &#123;<span class="attribute">width</span>: <span class="number">1000px</span>;&#125;</span><br></pre></td></tr></table></figure></div>

<p>我找到了专属于某个 select 的 option 下拉框区域的 ID。自己在全局的 css 样式中选择了这个专属样式，这才完成对此的修改。</p>
<h2 id="样式穿透"><a href="#样式穿透" class="headerlink" title="样式穿透"></a>样式穿透</h2><p>前置条件使用了 <code>scoped</code> ，当父组件想修改子组件里面的样式的时候，如果直接写子组件的样式，除了子组件根节点的样式，别的都是识别不到的。</p>
<p>要加上 <code>:：v-deep</code> 这个时候会给组件的作用域样式 <code>&lt;style scoped&gt;</code> 的每一个深度作用选择器前面的一个选择器单元增加一个属性选择器 <code>[data-v-实例标识]</code> ，示例：假设原选择器为 <code>.cls #id &gt;&gt;&gt; div</code>，则更改后的选择器为 <code>.cls #id[data-v-e0f690c0] div</code>；</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过这个问题，我了解了如何通过开发者工具定位一个 DOM 的样式，并且修改样式。</p>
<p><strong>以下结论针对 vue 的 scoped。</strong></p>
<p>如果是子组件的跟样式，直接修改</p>
<p>如果是子组件里的某个样式，用 <code>::v-deep</code></p>
<p>如果是特殊的，option 下拉框等，最终 html 呈现不在组件内部，用全局样式和特定选择器修改。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ElButton, ElSelect,ElOption &#125; from &#x27;element-plus&#x27;;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;el-button&gt;Default&lt;/el-button&gt;</span><br><span class="line">    &lt;el-select &gt;</span><br><span class="line">      &lt;el-option&gt;1&lt;/el-option&gt;</span><br><span class="line">      &lt;el-option&gt;2&lt;/el-option&gt;</span><br><span class="line">      &lt;el-option&gt;3&lt;/el-option&gt;</span><br><span class="line">      &lt;el-option&gt;4&lt;/el-option&gt;</span><br><span class="line">    &lt;/el-select&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">  .el-button&#123;</span><br><span class="line">    width: 500px;</span><br><span class="line">    display: block;</span><br><span class="line">  &#125;</span><br><span class="line">  ::v-deep .el-select__caret&#123;</span><br><span class="line">    color: red;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></div>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a class="link"   href="https://juejin.cn/post/7023343999909888037" >scoped,deep的原理<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   href="https://bilibili.com/video/BV1Jv41117QN/?spm_id_from=333.337.search-card.all.click&vd_source=115cedcdb1996c6483fb453252e441e6" >样式穿透<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>样式穿透</tag>
        <tag>scoped</tag>
        <tag>第三方组件</tag>
        <tag>样式修改</tag>
      </tags>
  </entry>
  <entry>
    <title>兼容鹏蓝设计样式</title>
    <url>/myBlog/2024/12/25/%E5%85%BC%E5%AE%B9%E9%B9%8F%E8%93%9D%E8%AE%BE%E8%AE%A1%E6%A0%B7%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>鹏蓝设计的基础组件样式包，只适配 element ui，原文如下 <code>theme-roc是基于element ui的Vue项目使用的dmce嵌套结构的scss样式包，前置条件为安装element UI和sass-loader相关依赖；</code></p>
<p>由于我是基于vue 3，element plus 开发的项目， element plus 很多样式原来的 element ui 没有，导致页面样式显示不全。</p>
<p>不能做到对这个样式包的开箱即用。需要有一套方案来解决问题。</p>
<h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><p>Element plus 降级为 element ui</p>
<ul>
<li>原文介绍 <code>element plus 是基于 Vue 3，面向设计师和开发者的组件库</code>  而 element ui 是基于 vue 2 的包括 vue 2 的生命周期，插槽语法，v-model 在 vue 3 中很难使用，这是技术本身不兼容，</li>
<li>Element plus 有许多新的属性，组件名称，事件和绑定，修改的话工作量大。</li>
<li>语法降级：将原先 V-model 语法糖需要改为 emit 的形式。需要使用到 this，根节点合并，生命周期函数名称更改。</li>
</ul>
<p><em>降级 vue 3</em></p>
<p><em>工作量</em>：</p>
<ul>
<li>对 30 多个组件从函数式 api 降级到 Options API ，因为我没有使用 vue 2 的 option api 就导致这里的书写风格是不一样的，都要改。</li>
<li>vue-router 降级，修改语法。</li>
</ul>
<p><em>学习成本</em></p>
<ul>
<li>Vue-router降级，options api ， vue 2要学习相应的语法，学习成本高，需要 2周时间。</li>
</ul>
<p><em>组件降级</em></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241217103510.png"
                     
                ></p>
<p>用了 30 左右 el 组件，每个组件都需要去官网核对是否需要修改属性，如果使用的属性 el-ui 没有则需要有对应解决方案。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241217104433.png"
                     
                ><br>比如 select 通过比对发现在 vue 2 中没有现有的插槽，需要通过别的方式来改造原有代码来保持原有的样式。</p>
<h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><p>加强鹏蓝设计的基础组件样式包，针对个别不兼容的样式，做额外兼容。额外兼容从理论上可以实现，根据页面效果增加类覆盖原有样式。</p>
<p><em>工作量</em>：根据效能开发组的指导，参考鹏蓝设计官网变量对 var. Css 进行变量替换，生成新的 element. Css，第一遍兼容大概需要一周（效能做需要 3 天）。</p>
<p><em>与鹏蓝同步更新</em>：现阶段包括 4 j都是本地更新，用效能的文件来自主替换已有 css，一旦 css 应用完不需要频繁更新，可以长期使用一份文档。</p>
<p><em>与Element plus 更新</em>：如果plus 更新，我也是使用的官方推荐的变量覆盖方法，因为是官方的做法所以不存在兼容性的问题，也就是 plus 升级不能全量覆盖的问题。</p>
<p><em>全量替换</em>：按照官网的方式可以做到对所有组件的全量替换。</p>
<p><em>后续开发</em>：后续效能会针对布局有一次单独开发，这个需要我后续同步跟进，做法和现在一样，到时候用他们的变量来覆盖，我需要负责和 plus 对接。</p>
<h2 id="方案对比"><a href="#方案对比" class="headerlink" title="方案对比"></a>方案对比</h2><p>方案一</p>
<p>优势：鹏蓝设计自动维护主题</p>
<p>缺点：工作量大，涉及的文件多改动多，可能出现 bug，学习成本大。使用Vue 3 性能好，更加灵活。</p>
<p>方案二</p>
<p>优势：工作量小，代码改动小</p>
<p>缺点：需要自己来实现变量和布局的适配</p>
<h2 id="方案二开发流程"><a href="#方案二开发流程" class="headerlink" title="方案二开发流程"></a>方案二开发流程</h2><p>在 element-plus 官网下载需要覆盖的文件</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241217105025.png"
                     
                ></p>
<p>参考鹏蓝设计官网变量对默认的 var. Css 进行变量替换，利用编译器生成新的 element. Css 覆盖原有的 element 文件。</p>
<p>第一遍兼容大概需要一周（效能做需要 3 天）。</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>由于鹏蓝设计样式基于 element ui ，里面的样式的选择器保持了一致，导致优先级是按照 css 引入顺序决定的，vite动态import导致css动态的导入，被添加在script最下面，覆盖了样式怎么办。</p>
<p>可以把鹏蓝的 element 样式覆盖类文件放到 body 里，这样他的优先级永远是最高的。</p>
]]></content>
  </entry>
  <entry>
    <title>实现一个简单的通证合约</title>
    <url>/myBlog/2024/12/25/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E9%80%9A%E8%AF%81%E5%90%88%E7%BA%A6/</url>
    <content><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>实现一个自己的通证，并且通过 sepolia 发送给满足特定要求的账户。</p>
<h2 id="FundMe"><a href="#FundMe" class="headerlink" title="FundMe"></a>FundMe</h2><div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.20</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">AggregatorV3Interface</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@chainlink/contracts/src/v0.8/shared/interfaces/AggregatorV3Interface.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">FundMe</span> &#123;</span><br><span class="line">    <span class="title function_">mapping</span> (<span class="function"><span class="params">address</span> =&gt;</span>uint256) public fundersToAmount;</span><br><span class="line">    uint256 <span class="variable constant_">MINIMUM_VALUE</span> = <span class="number">1</span> * <span class="number">10</span> ** <span class="number">18</span>;</span><br><span class="line">    <span class="title class_">AggregatorV3Interface</span> internal dataFeed;</span><br><span class="line"></span><br><span class="line">    uint256 constant <span class="variable constant_">TARGET</span> = <span class="number">100</span> * <span class="number">10</span> ** <span class="number">18</span>;</span><br><span class="line">    </span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    address erc20Addr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//告诉通证合约是否完成了资金募集。</span></span><br><span class="line">    bool public getFundSuccess = <span class="literal">false</span>; </span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// sepolia testnet</span></span><br><span class="line">        dataFeed = <span class="title class_">AggregatorV3Interface</span>(<span class="number">0x694AA1769357215DE4FAC081bf1f309aDC325306</span>);</span><br><span class="line">        owner = msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">fund</span>(<span class="params"></span>) external payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">convertETHToUsd</span>(msg.<span class="property">value</span>) &gt;= <span class="variable constant_">MINIMUM_VALUE</span>, <span class="string">&quot;send more ETH&quot;</span> );</span><br><span class="line">        fundersToAmount[msg.<span class="property">sender</span>] = msg.<span class="property">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getChainlinkDataFeedLatestAnswer</span>(<span class="params"></span>) public view <span class="title function_">returns</span> (int) &#123;</span><br><span class="line">        <span class="comment">// prettier-ignore</span></span><br><span class="line">        (</span><br><span class="line">            <span class="comment">/* uint80 roundID */</span>,</span><br><span class="line">            int answer,</span><br><span class="line">            <span class="comment">/*uint startedAt*/</span>,</span><br><span class="line">            <span class="comment">/*uint timeStamp*/</span>,</span><br><span class="line">            <span class="comment">/*uint80 answeredInRound*/</span></span><br><span class="line">        ) = dataFeed.<span class="title function_">latestRoundData</span>();</span><br><span class="line">        <span class="keyword">return</span> answer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">convertETHToUsd</span>(<span class="params">uint256 ethAmount</span>) internal view <span class="title function_">returns</span>(<span class="params">uint256</span>)&#123;</span><br><span class="line">        uint256 ethPrice = <span class="title function_">uint256</span>(<span class="title function_">getChainlinkDataFeedLatestAnswer</span>());</span><br><span class="line">        <span class="comment">//因为chainlink精度是10*8所以，除法之后得到的usd</span></span><br><span class="line">        <span class="keyword">return</span> ethAmount * ethPrice/(<span class="number">10</span>**<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//合约的拥有者可以取回募集的资金</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getFund</span>(<span class="params"></span>) external  &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">convertETHToUsd</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>) &gt;= <span class="variable constant_">TARGET</span>,<span class="string">&quot;Target is not reached&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == owner,<span class="string">&quot;the function can only be called by owner&quot;</span>);</span><br><span class="line">        <span class="comment">//solidity三个转账方式</span></span><br><span class="line">        <span class="title function_">payable</span> (msg.<span class="property">sender</span>).<span class="title function_">transfer</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>);</span><br><span class="line">        fundersToAmount[msg.<span class="property">sender</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//第二种</span></span><br><span class="line">        <span class="comment">//         bool success = payable(msg.sender).send(address(this).balance);</span></span><br><span class="line">        <span class="comment">// require(success, &quot;Send failed&quot;);</span></span><br><span class="line">        getFundSuccess = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">//第三种是call</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户可以取回自己的coin</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">refund</span>(<span class="params"></span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">convertETHToUsd</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>) &lt; <span class="variable constant_">TARGET</span>,<span class="string">&quot;Target is reached&quot;</span>);</span><br><span class="line">        uint256 amount = fundersToAmount[msg.<span class="property">sender</span>];</span><br><span class="line">        <span class="built_in">require</span>(amount != <span class="number">0</span> , <span class="string">&quot;there is no fund for you&quot;</span>);</span><br><span class="line">        bool success;</span><br><span class="line">        (success, ) = <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="property">call</span>&#123;<span class="attr">value</span>:amount&#125;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(success,<span class="string">&quot;transfer tx failed&quot;</span>);</span><br><span class="line">        fundersToAmount[msg.<span class="property">sender</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferOwnership</span>(<span class="params">address newOwner</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == owner,<span class="string">&quot;the function can only be called by owner&quot;</span>);</span><br><span class="line">        owner = newOwner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//限定只有erc20可以调用这个合约的这两个方法，来设置合约的余额。</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setErc20Addr</span>(<span class="params">address _erc20Addr</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == owner,<span class="string">&quot;the function can only be called by owner&quot;</span>);</span><br><span class="line">        erc20Addr = _erc20Addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setFunderToAmount</span>(<span class="params">address funder, uint256 amountToUpdate</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == erc20Addr,<span class="string">&quot;you do not have permission to call&quot;</span>);</span><br><span class="line">        fundersToAmount[funder] = amountToUpdate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<h2 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h2><div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">ERC20</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">FundMe</span>&#125; <span class="keyword">from</span> <span class="string">&quot;./FundMe.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">FundTokenERC20</span> is <span class="title class_">ERC20</span> &#123;</span><br><span class="line">    <span class="title class_">FundMe</span> fundMe;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address fundMeAddr</span>) <span class="title class_">ERC20</span>(<span class="string">&quot;FundTokenERC20&quot;</span>,<span class="string">&quot;FT&quot;</span>)&#123;</span><br><span class="line">        fundMe = <span class="title class_">FundMe</span>(fundMeAddr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">mint</span>(<span class="params">uint256 amountToMint</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(fundMe.<span class="title function_">fundersToAmount</span>(msg.<span class="property">sender</span>) &gt;= amountToMint, <span class="string">&quot;you cannot mint this many tokens&quot;</span>);</span><br><span class="line">        <span class="comment">//solidity隐式的创建每一个public变量的set函数。</span></span><br><span class="line">        <span class="built_in">require</span>(fundMe.<span class="title function_">getFundSuccess</span>(),<span class="string">&quot;not completed yet&quot;</span>);</span><br><span class="line">        <span class="title function_">_mint</span>(msg.<span class="property">sender</span>,amountToMint);</span><br><span class="line">        fundMe.<span class="title function_">setFunderToAmount</span>(msg.<span class="property">sender</span>,fundMe.<span class="title function_">fundersToAmount</span>(msg.<span class="property">sender</span>) - amountToMint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">claim</span>(<span class="params">uint256 amountToClaim</span>) public &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">balanceOf</span>(msg.<span class="property">sender</span>) &gt;= amountToClaim,<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">        <span class="title function_">_burn</span>(msg.<span class="property">sender</span>,amountToClaim);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="怎么测试"><a href="#怎么测试" class="headerlink" title="怎么测试"></a>怎么测试</h3><p>先建立 FundMe 合约，传入建立好的 fundeme 合约生成一个引入特定合约的通证合约。<br>由于 fundme 合约需要通证合约地址来找到他，所以仍需要把通证合约地址给到 fundme 合约。<br>然后就可以 fund - getfund - mint - totalSupply 的顺序来测试合约的完成度。<br>测试合约使用者，合约拥有者，是否可以执行对应的方法。</p>
<p>拥有者主要测试能否创建合约，getFund,transferOwnership，setErc20Addr。<br>合约使用者测试是否可以refund，fund。</p>
<h3 id="在哪里测试"><a href="#在哪里测试" class="headerlink" title="在哪里测试"></a>在哪里测试</h3><ul>
<li>在 remix 里测试</li>
<li>在 etherscan 中测试，验证和部署到测试网，可以让所有人来验证合约，并开源。</li>
</ul>
<h3 id="查看测试结果"><a href="#查看测试结果" class="headerlink" title="查看测试结果"></a>查看测试结果</h3><p>登录<a class="link"   href="https://sepolia.etherscan.io/" >以太坊区块链浏览器<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ，查看和分析以太坊网络上的所有交易、区块、地址、合约等信息。</p>
<p>合约使用者确实收到了通证。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241219180703.png"
                     
                ></p>
]]></content>
  </entry>
  <entry>
    <title>性能和指标</title>
    <url>/myBlog/2024/12/03/%E6%80%A7%E8%83%BD%E5%92%8C%E6%8C%87%E6%A0%87/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们首先需要了解整个页面绘制的原理<a href="%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.md">浏览器工作原理</a>，了解各个时间节点浏览器做了什么，针对不同的节点进行优化。</p>
<h2 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h2><h3 id="渲染时机"><a href="#渲染时机" class="headerlink" title="渲染时机"></a>渲染时机</h3><p>FP：首次绘制时间<br>FCP：FCP 通常意味着浏览器在 DOM 树和 CSSOM 树完成初步构建后，将第一个可见内容渲染到屏幕上。<br>DCL：DCL 对应于整个 HTML 文档被浏览器完全解析的时刻，此时已经生成完整的 DOM 树，但外部资源（如图片和样式表）可能还未完全加载。对应了 <code>DOMContentLoaded</code> 事件<br>L：Load Event 代表的是页面上的所有资源（包括样式表、图片、JavaScript 文件等）都已加载完成，意味着浏览器已经完成了从服务器下载页面的全部资源，并且所有资源都已完全展示。Load 对应的事件是 <code>load</code><br><strong>LCP</strong>： 是衡量用户感知页面主要内容加载的关键指标，它能帮助开发者找到影响页面加载体验的问题。</p>
<blockquote>
<p>可以在开发者工具看到他们的耗时</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241130115558.png"
                     
                ></p>
<h3 id="Core-Web-Vitals"><a href="#Core-Web-Vitals" class="headerlink" title="Core Web Vitals"></a>Core Web Vitals</h3><p>Web Vitals 是谷歌推出的一项旨在为提供优质网络用户体验的必要质量信号提供统一指导的倡议。</p>
<p>LCP：同上<br>INP：反映用户在交互时页面响应的延迟，关注用户操作的流畅性。<br>CLS：评估页面布局的稳定性，防止加载中内容“跳动”影响用户体验。</p>
<h3 id="RAIL-运行时性能模型"><a href="#RAIL-运行时性能模型" class="headerlink" title="RAIL 运行时性能模型"></a>RAIL 运行时性能模型</h3><p>RAIL 是一种以用户为中心的性能模型，为思考性能提供了结构。该模型将用户的体验分解为关键动作（例如，点击、滚动、加载）并帮助您为每个动作定义性能目标。</p>
<p>RAIL 代表 Web 应用生命周期中的四个不同方面：响应、动画、空闲和加载。用户对每个这些上下文都有不同的性能期望，因此性能目标是基于上下文和用户体验研究如何感知延迟来定义的。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/myBlog/attachment/Pasted%20image%2020241202164449.png"
                     
                ></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link"   href="https://web.dev/articles/rail" >rail模型<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
  </entry>
  <entry>
    <title>整合现有项目，搭建monorepo</title>
    <url>/myBlog/2024/11/04/%E6%95%B4%E5%90%88%E7%8E%B0%E6%9C%89%E9%A1%B9%E7%9B%AE%EF%BC%8C%E6%90%AD%E5%BB%BAmonorepo/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于我在开发项目或者练习的时候，不喜欢新建仓库，一个个 clone，所以我把所有的项目丢到一个仓库里，这样我可以在不同的项目中反复横跳，方便的修改，并且通过一个 git 请求，上传到 git。但这造成一个问题，也是多包仓库一个共同问题，依赖重复度高，偶然的机会让我接触到 <code>monorepo</code> ，于是打算深入一下，重构一下我的仓库。</p>
<h2 id="为什么使用-Monorepo"><a href="#为什么使用-Monorepo" class="headerlink" title="为什么使用 Monorepo"></a>为什么使用 Monorepo</h2><ul>
<li><strong>代码库的可见性</strong>：使用 Monorepo 可以让你轻松查看公司所有的代码库，而不需要去查找和克隆多个不同的仓库。</li>
<li><strong>一致性</strong>：Monorepo 能保持代码风格和配置的一致性。你可以在多个项目间共享 ESLint 配置、UI 组件库以及设计系统中的 Web 组件、实用工具库和文档。</li>
<li><strong>依赖管理的优势</strong>：Monorepo 的真正优势在于依赖管理，它可以帮助你直观地查看整个项目的依赖关系图。此外，对于第三方依赖库，它能够在多个应用中去重使用，从而减少重复安装的包。</li>
<li><strong>持续集成和自动化</strong>：Monorepo 非常适合用于持续集成和自动化流程，因为它可以轻松地一起构建和测试所有项目。</li>
</ul>
<blockquote>
<p>相比之下，Polyrepo 是一种传统的多仓库模式。Polyrepo 需要在不同的项目之间共享代码，通常流程较为复杂。</p>
</blockquote>
<h2 id="Monorepo-的常见问题"><a href="#Monorepo-的常见问题" class="headerlink" title="Monorepo 的常见问题"></a>Monorepo 的常见问题</h2><ul>
<li><strong>构建时间较长</strong>：随着项目规模增大，构建整个 Monorepo 会消耗更多时间。</li>
<li><strong>编辑器性能问题</strong>：在大型 Monorepo 中，VSCode 可能会因为处理大量的 Git 历史记录而出现卡顿。</li>
<li><strong>CI&#x2F;CD 速度缓慢</strong>：在持续集成和部署流程中，Monorepo 会占用更多资源，导致速度变慢。</li>
</ul>
<p>正因为如此，我们需要合适的工具来优化 Monorepo 的性能。Monorepo 官网定义了一系列构建工具需要遵守的约定，并且比较了市面上流行的 monorepo 构建工具，我们可以选择自己需要的工具。</p>
<h2 id="Turborepo"><a href="#Turborepo" class="headerlink" title="Turborepo"></a>Turborepo</h2><p>我们这里直接使用工具来搭建第一个 monorepo，而不用原始的手段，这可以很好避免上述的常见问题。<br>Turborepo 是一个优化 Monorepo 工作流的工具。在官网上介绍了多种可以用于 Monorepo 的工具，接下来我会挑选 Turborepo 进行讲解，展示它如何提升 Monorepo 的效率。</p>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><p>Turborepo 遵循了官网的 monorepo 最佳实践的相关约定，并且将构建速度做了很大提升。</p>
<h3 id="Workspace-定义"><a href="#Workspace-定义" class="headerlink" title="Workspace 定义"></a>Workspace 定义</h3><p>在 Monorepo 的根目录的 <code>package.json</code> 中定义 <code>workspaces</code>，它会在第一层目录下查找带有 <code>package.json</code> 的文件夹，并将其识别为一个 workspace。</p>
<h3 id="共享配置"><a href="#共享配置" class="headerlink" title="共享配置"></a>共享配置</h3><p>他可以在 package 文件夹中创建 <code>tailwind.config.js</code> 配置文件包，在别的项目引入。</p>
<p>For example we want to share a tailwind config. We can generate a tailwind config and a package. Json in file.</p>
<p>If we need to support both commonJs and ESM ,we need to provide two js files.</p>
<p>Cjs. Js</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages/tailwind-config/tailwind.config.cjs</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">content</span>: [</span><br><span class="line">    <span class="comment">// 其他项目可以在各自配置中重写 content 部分</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">theme</span>: &#123;</span><br><span class="line">    <span class="attr">extend</span>: &#123;</span><br><span class="line">      <span class="attr">colors</span>: &#123;</span><br><span class="line">        <span class="attr">primary</span>: <span class="string">&#x27;#3490dc&#x27;</span>,</span><br><span class="line">        <span class="attr">secondary</span>: <span class="string">&#x27;#ffed4a&#x27;</span>,</span><br><span class="line">        <span class="attr">accent</span>: <span class="string">&#x27;#38c172&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">spacing</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;72&#x27;</span>: <span class="string">&#x27;18rem&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;84&#x27;</span>: <span class="string">&#x27;21rem&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;96&#x27;</span>: <span class="string">&#x27;24rem&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>Esm. Js</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages/tailwind-config/tailwind.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">content</span>: [</span><br><span class="line">    <span class="comment">// 其他项目可以在各自配置中重写 content 部分</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">theme</span>: &#123;</span><br><span class="line">    <span class="attr">extend</span>: &#123;</span><br><span class="line">      <span class="attr">colors</span>: &#123;</span><br><span class="line">        <span class="attr">primary</span>: <span class="string">&#x27;#3490dc&#x27;</span>,</span><br><span class="line">        <span class="attr">secondary</span>: <span class="string">&#x27;#ffed4a&#x27;</span>,</span><br><span class="line">        <span class="attr">accent</span>: <span class="string">&#x27;#38c172&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">spacing</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;72&#x27;</span>: <span class="string">&#x27;18rem&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;84&#x27;</span>: <span class="string">&#x27;21rem&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;96&#x27;</span>: <span class="string">&#x27;24rem&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>Package. Json</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@my-monorepo/tailwind-config&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./tailwind.config.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exports&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;import&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./tailwind.config.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./tailwind.config.cjs&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;module&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MIT&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;tailwind.config.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;tailwind.config.cjs&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;peerDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tailwindcss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>Then we can install and use the config in other items. Its pnpm package. Json<br>Below </p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@my-monorepo/tailwind-config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;workspace:*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tailwindcss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>In the tailwind. Config. Js we can write like . Show a commonjs way to import.</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// apps/app1/tailwind.config.js</span></span><br><span class="line"><span class="keyword">const</span> sharedConfig = <span class="built_in">require</span>(<span class="string">&#x27;@my-monorepo/tailwind-config&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [sharedConfig],</span><br><span class="line">  <span class="attr">content</span>: [</span><br><span class="line">    <span class="string">&quot;./src/**/*.&#123;js,jsx,ts,tsx&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;./public/index.html&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>


<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>全程跟着官网来没什么毛病。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a class="link"   href="https://turbo.build/repo/docs/getting-started" >turbo官网<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   href="https://monorepo.tools/#local-computation-caching" >monorepo 官网<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   href="https://www.youtube.com/watch?v=9iU_IE6vnJ8" >Monorepos - How the Pros Scale Huge Software Projects &#x2F;&#x2F; Turborepo vs Nx<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>浏览器工作原理</title>
    <url>/myBlog/2024/11/04/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h3><p>进程：就是程序的运行实例，当我们启动一个程序，操作系统会创建一个内存，里面可以有多个线程。<br>线程：负责当前任务中程序的执行</p>
<p>特点：</p>
<ul>
<li>同一个进程的线程数据共享</li>
<li>一个线程崩溃，整个进程崩溃</li>
<li>进程关闭后，内存会回收</li>
<li>不同进程相互隔离，通过IPC通讯</li>
</ul>
<h2 id="chrome多进程架构"><a href="#chrome多进程架构" class="headerlink" title="chrome多进程架构"></a>chrome多进程架构</h2><p>chorme架构主要包括了浏览器主进程，网络进程，GPU进程，渲染进程，插件进程，缓存进程。浏览器默认情况下会为每个标签页创建一个进程</p>
<p>![[浏览器原理]]</p>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><ul>
<li>浏览器主进程：获取 URL，格式正确会给 URL 加上协议，通过进程间通信发送给网络进程</li>
<li>网络进程：<ul>
<li>先查看是否有缓存资源，如果没有就先进行 DNS 解析，将域名转为 ip 地址。如果协议是 HTTPS 那么会建立 TLS 连接，</li>
<li>然后浏览器构建请求头和请求体向服务器发送请求，服务端返回响应内容。</li>
<li>SafeBrowsing 对返回站点内容做检查，如果是不安全的就会给与安全提示</li>
<li>一旦浏览器接受就先解析响应行（可能会有重定向），然后是响应头，如果 content-type 是 <code>text/html</code> 那么就会开启一个渲染进程。<br>每个域名都会开启一个渲染进程，同域名一般只会有一个，这种方式可以避免不同标签页之间数据共享，卡死</li>
</ul>
</li>
<li>渲染进程：<ul>
<li>通过 IPC 管道接受网络进程响应体的内容，这时候浏览器进入白屏等待渲染进程进行渲染。</li>
<li>HTML 解析成 DOM 树：当解析器发现非阻塞资源，例如一张图片，浏览器会请求这些资源并且继续解析。当遇到一个 CSS 文件时，解析也可以继续进行，但是对于 <code>&lt;script&gt;</code> 标签（特别是没有 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function"><code>async</code></a> 或者 <code>defer</code> 属性的）会阻塞渲染并停止 HTML 的解析。尽管浏览器的预加载扫描器加速了这个过程，但过多的脚本仍然是一个重要的瓶颈。</li>
<li>计算样式：处理 CSS 并构建 CSSOM 树</li>
<li>JavaScript 编译：[[js编译原理]]<blockquote>
<p>chrome 使用的渲染引擎是 Blink，而 js 引擎是 V 8，渲染引擎在渲染时遇到 js 会去执行代码调用 js 引擎。</p>
</blockquote>
</li>
<li>布局：根据 DOM 树和已经计算好的样式，生成一个布局树。</li>
<li>分层</li>
<li>绘制</li>
<li>合成：<ul>
<li>主线程完成以上的工作后，将信息传递给合成器线程，将每个图层切分为很多图块，将每个图块发送给栅格线程，每个栅格线程会栅格化图块。</li>
<li>根据这些信息，合成器线程生成合成器帧传递给浏览器进程，然后给到 GPU，渲染到屏幕上</li>
</ul>
</li>
<li>交互</li>
</ul>
</li>
</ul>
<blockquote>
<p>HTML 解析，css 样式解析，js 编译都是在渲染进程的主线程中执行，当重绘和重排比较频繁时，js 执行时间过长，容易造成页面的卡顿。</p>
</blockquote>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a class="link"   href="https://www.bilibili.com/video/BV1tc41157Va/?spm_id_from=333.337.search-card.all.click&vd_source=115cedcdb1996c6483fb453252e441e6" >浏览器历史和渲染原理<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   href="https://developer.mozilla.org/zh-CN/docs/Web/Performance/How_browsers_work" >MDN：浏览器工作原理<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   href="https://www.bilibili.com/video/BV1x54y1B7RE/?spm_id_from=333.788.recommend_more_video.-1&vd_source=115cedcdb1996c6483fb453252e441e6" >干货】浏览器是如何运作的？<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>聊聊前端缓存</title>
    <url>/myBlog/2024/10/13/%E8%81%8A%E8%81%8A%E5%89%8D%E7%AB%AF%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>前端缓存是一个很大的概念，网上的资料写的都是零零散散的，所以我这里把他们做一个知识串联。</p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p>按照大类来分可以分为为了资源加载优化的缓存和本地数据存储。<br>比如：CDN 缓存，浏览器缓存，HTTP缓存。本地数据存储</p>
<blockquote>
<p><strong>本篇的缓存和本地数据存储是两个不同的概念</strong><br>LocalStorage 并不算缓存，他是前端开发者手动管理的持久性存储，他不参与 HTTP 请求，只在客户端中存储键值对数据，为了存储数据。而浏览器缓存里的本地缓存则是，是浏览器自动管理的资源缓存，为了资源加载优化，保存的是浏览器的静态资源。<br>本地数据存储是用于存储应用程序状态和用户数据的理想选择，而缓存更侧重于提升性能和减少网络请求。</p>
</blockquote>
<h2 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h2><ul>
<li>用于存储用户数据，生命周期较长，除非主动清除</li>
<li>使用 <strong>JavaScript API</strong> 操作</li>
</ul>
<h3 id="分类-1"><a href="#分类-1" class="headerlink" title="分类"></a>分类</h3><p>localStorage, sessionStorage, cookie, WebSql, indexedDB</p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><ul>
<li>缓存是由 HTTP 头部（Cache-Control 等）控制，也就是属于 http 缓存</li>
<li>通过缓存策略实现自动管理，</li>
<li>用于存储静态资源和 API 响应，提升页面性能，但生命周期较短。</li>
</ul>
<p>Http 缓存分为强缓存和协商缓存，以下的两个缓存都收到 http 设置的影响。</p>
<h3 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h3><p>HTTP 响应头决定了哪些资源应该缓存、缓存多久，以及是否要每次请求都检查资源的更新。浏览器会根据资源的特性和使用场景，自动决定资源是存储在内存缓存（Memory Cache）还是磁盘缓存（Disk Cache）</p>
<p>分为：</p>
<ul>
<li><strong>内存缓存</strong>（Memory Cache）：短时间保存，浏览器关闭后清空。</li>
<li><strong>磁盘缓存</strong>（Disk Cache）：长期保存，浏览器重启后仍可使用。</li>
<li><strong>Service Worker 缓存</strong>：特殊的缓存，供 PWA 使用。</li>
</ul>
<h3 id="CDN-缓存"><a href="#CDN-缓存" class="headerlink" title="CDN 缓存"></a>CDN 缓存</h3><p>网页内容分为静态内容和动态内容，就算是静态内容也不是一定用 <code>CDN</code>。源服务器在分发内容的时候，会在 <code>http</code> 响应头增加 <code>cache-control</code>，告诉 <code>CDN</code> 哪些要缓存，缓存多久。<br>但是动态内容，每次 CDN 服务器都要重新向源服务器拿，那这个就没多大的意义了。但是也有解决方案（省略）。</p>
<p>CDN 负载均衡服务器会监控每个 CDN 服务器的负载情况，来平均分配网络的流量，</p>
<p>CDN 的确能提升性能，但缓存有效性、用户访问分布、缓存策略配置都会影响它的效果。简单来说：流量高且集中的站点：CDN 缓存效果非常明显，能够减少大量源站请求。流量小且分散的站点：CDN 的效果有限，某些情况下，访问速度甚至不如直接从源站获取快。合理配置缓存策略、TTL、以及区域缓存同步对于提升 CDN 效果至关重要。</p>
<h2 id="浏览器缓存命中执行顺序"><a href="#浏览器缓存命中执行顺序" class="headerlink" title="浏览器缓存命中执行顺序"></a>浏览器缓存命中执行顺序</h2><ol>
<li>是否存在内存缓存？<br>└─ 是 → 使用内存缓存<br>└─ 否 → 2. Service Worker 是否可用？<br>└─ 是 → 使用 Service Worker 缓存<br>└─ 否 → 3. 是否存在磁盘缓存？<br>    └─ 是 → 使用磁盘缓存<br>     └─ 否 → 从网络或 CDN 获取资源</li>
</ol>
]]></content>
      <tags>
        <tag>缓存</tag>
        <tag>本地存储</tag>
      </tags>
  </entry>
  <entry>
    <title>首次认识函数式编程</title>
    <url>/myBlog/2024/10/14/%E9%A6%96%E6%AC%A1%E8%AE%A4%E8%AF%86%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><ul>
<li>函数式是声明式编程的一种，强调做什么而不是怎么做</li>
<li>函数式编程是一种将函数视为“一等公民”的编程范式。它强调纯函数、不可变性和避免副作用。程序的逻辑主要通过函数组合完成。</li>
</ul>
<h2 id="纯函数"><a href="#纯函数" class="headerlink" title="纯函数"></a>纯函数</h2><p>函数的变量只依赖自身的执行上下文，而不会根据作用域链找别的执行上下文, 这样的函数是外界隔离的，也就是没有副作用的。</p>
<blockquote>
<p>副作用是指函数在执行的时候，会影响别人的执行上下文，影响外部的状态。</p>
</blockquote>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这个函数不是纯的，因为console是通过全局上下文确定的</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dem</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(a+b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这种设计是对代码进行了限制，用自由度换取了后期代码的可维护性。使用纯函数意味着你的函数中<strong>不存在指向不明的 this，不存在对全局变量的引用，不存在对参数的修改</strong></p>
<h2 id="变量不可变性"><a href="#变量不可变性" class="headerlink" title="变量不可变性"></a>变量不可变性</h2><p>在函数式编程中，不可变性（Immutability）是指：变量一旦创建，就不能被修改。而是通过创建新变量或对象的副本，代替直接修改原变量。这种设计提高了程序的可靠性、可预测性，并避免了共享状态带来的问题。</p>
<blockquote>
<p>一旦传入函数的参数是引用类型，那我们必须先进行一次深拷贝。</p>
</blockquote>
<h2 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h2><p>higher-order function is a function that either take a function as a argument or returns a function as a result</p>
<p>Divided to two types : enhancing function, framework function</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Function : enhancing function </span></span><br><span class="line"><span class="comment">//we can reuse the enhancement logic across multiple functions,we can return a array to do more jobs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">eat</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;eat&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">run</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;run&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">count</span> = (<span class="params">func</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="function">(<span class="params">...args</span>) =&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">func</span>(args)</span><br><span class="line">            count++</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function">() =&gt;</span>&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(count)</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> [countEat,getCount] = <span class="title function_">count</span>(eat)</span><br><span class="line"><span class="title function_">countEat</span>()</span><br><span class="line"><span class="title function_">countEat</span>()</span><br><span class="line"><span class="title function_">countEat</span>()</span><br><span class="line"><span class="title function_">countEat</span>()</span><br><span class="line"><span class="title function_">getCount</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function : framework function </span></span><br><span class="line"><span class="comment">//facilitate common tasks and abstract away complexity. those functions allow developer to focus on high-level logic without worrying about the underlying implementation</span></span><br><span class="line"><span class="comment">//for example : we use reduce to implement a map</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">myMap</span> = (<span class="params">arr, callback</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(<span class="function">(<span class="params">pre, cur</span>) =&gt;</span> &#123;</span><br><span class="line">        pre.<span class="title function_">push</span>(<span class="title function_">callback</span>(cur));  <span class="comment">// Push the result from callback</span></span><br><span class="line">        <span class="keyword">return</span> pre;  <span class="comment">// Return the accumulator</span></span><br><span class="line">    &#125;, []);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = <span class="title function_">myMap</span>(a, <span class="function">(<span class="params">item</span>) =&gt;</span> item * item);  <span class="comment">// Return value directly</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b);  <span class="comment">// [1, 4, 9]</span></span><br></pre></td></tr></table></figure></div>


<h2 id="函数组合"><a href="#函数组合" class="headerlink" title="函数组合"></a>函数组合</h2><p>Functions composition refers to combining multiple funcitions such that the output of one function becomes the input of the next.  This can chain the functions together to perform complex transformation in a cleaner and more readable way.</p>
<p>We can define a function called pipe to implement the functions composition</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//functions composition</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">pipe</span> = (<span class="params">...func</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">input</span> =&gt;</span> &#123;</span><br><span class="line">        func.<span class="title function_">reduce</span>(<span class="function">(<span class="params">pre,cur</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">cur</span>(pre)</span><br><span class="line">        &#125;,input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<h2 id="柯里化"><a href="#柯里化" class="headerlink" title="柯里化"></a>柯里化</h2><p>When a function has two input parameters, the pipe mentioned above cannot use the function as a parameter, because the pipeline has only one entry. At this time, currying is required to convert 1 function with n parameters into n functions with one parameter.</p>
<p>This makes functions more reusable and allows partial application of arguments.</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//currying </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">curry</span> = (<span class="params">func,arg</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(!arg)&#123;</span><br><span class="line">        arg = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">input</span>) =&gt;</span>&#123;</span><br><span class="line">        arg.<span class="title function_">push</span>(input)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(arg.<span class="property">length</span> &gt;= func.<span class="property">length</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">func</span>(...arg)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">curry</span>(func,arg)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>Once your function is currying, then you can fix several arguments util one argument left ,then you can use the curried function as a arguments of pipe.</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; curry, pipe, filter, prop &#125; = R;</span><br><span class="line"><span class="comment">// code here</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  ex1 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// :: String -&gt; Number -&gt; Object -&gt; Boolean</span></span><br><span class="line"><span class="keyword">const</span> propLt = <span class="title function_">curry</span>(<span class="function">(<span class="params">p, c</span>) =&gt;</span> R.<span class="title function_">pipe</span>(R.<span class="title function_">prop</span>(p), R.<span class="title function_">lt</span>(R.<span class="property">__</span>, c)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// :: Object -&gt;  Boolean</span></span><br><span class="line"><span class="keyword">const</span> ageUnder18 = <span class="title function_">propLt</span>(<span class="string">&quot;age&quot;</span>, <span class="number">18</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// :: [a] -&gt; b </span></span><br><span class="line"><span class="keyword">const</span> getAgeUnder18 = R.<span class="title function_">pipe</span>(</span><br><span class="line">  R.<span class="title function_">filter</span>(ageUnder18),</span><br><span class="line">  R.<span class="title function_">map</span>(R.<span class="title function_">pickAll</span>([<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>]))</span><br><span class="line">);</span><br></pre></td></tr></table></figure></div>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>前面介绍了很多函数式编程的概念可以总结出函数式编程的优点：</p>
<ul>
<li><strong>代码简洁，开发快速</strong>：函数式编程大量使用函数的组合，函数的复用率很高，减少了代码的重复，因此程序比较短，开发速度较快。Paul Graham 在《黑客与画家》一书中写道：同样功能的程序，极端情况下，Lisp 代码的长度可能是 C 代码的二十分之一。</li>
<li><strong>接近自然语言，易于理解</strong>：函数式编程大量使用声明式代码，基本都是接近自然语言的，加上它没有乱七八糟的循环，判断的嵌套，因此特别易于理解。</li>
<li>**易于”并发编程”**：函数式编程没有副作用，所以函数式编程不需要考虑“死锁”（Deadlock），所以根本不存在“锁”线程的问题。</li>
<li><strong>更少的出错概率</strong>：因为每个函数都很小，而且相同输入永远可以得到相同的输出，因此测试很简单，同时函数式编程强调使用纯函数，没有副作用，因此也很少出现奇怪的 Bug。</li>
</ul>
<p>因此，如果用一句话来形容函数式编程，应该是：<code>Less code, fewer bugs</code> 。因为写的代码越少，出错的概率就越小。人是最不可靠的，我们应该尽量把工作交给计算机。</p>
<p>一眼看下来好像函数式可以解决所有的问题，但是实际上，函数式编程也不是什么万能的灵丹妙药。正因为函数式编程有以上特点，所以它天生就有以下缺陷：</p>
<ul>
<li><p><strong>性能</strong>：函数式编程相对于指令式编程，性能绝对是一个短板，因为它往往会对一个方法进行过度包装，从而产生上下文切换的性能开销。同时，在 JS 这种非函数式语言中，函数式的方式必然会比直接写语句指令慢（引擎会针对很多指令做特别优化）。就拿原生方法 <code>map</code> 来说，它就要比纯循环语句实现迭代慢 8 倍。</p>
</li>
<li><p><strong>资源占用</strong>：在 JS 中为了实现对象状态的不可变，往往会创建新的对象，因此，它对垃圾回收（Garbage Collection）所产生的压力远远超过其他编程方式。这在某些场合会产生十分严重的问题。</p>
</li>
<li><p><strong>递归陷阱</strong>：在函数式编程中，为了实现迭代，通常会采用递归操作，为了减少递归的性能开销，我们往往会把递归写成尾递归形式，以便让解析器进行优化。但是众所周知，JS 是不支持尾递归优化的（虽然 ES6 中将尾递归优化作为了一个规范，但是真正实现的少之又少，<a class="link"   href="https://link.juejin.cn/?target=http://kangax.github.io/compat-table/es6/"  title="http://kangax.github.io/compat-table/es6/">传送门<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>）</p>
</li>
<li><p>……</p>
</li>
</ul>
<p>因此，在性能要求很严格的场合，函数式编程其实并不是太合适的选择。</p>
<p>但是换种思路想，软件工程界从来就没有停止过所谓的银弹之争，却也从来没诞生过什么真正的银弹，各种编程语言层出不穷，各种框架日新月异，各种编程范式推陈出新，结果谁也没有真正的替代谁。</p>
<p>学习函数式编程真正的意义在于：让你意识到在指令式编程，面向对象编程之外，还有一种全新的编程思路，一种用函数的角度去<strong>抽象</strong>问题的思路。学习函数式编程能大大丰富你的武器库，不然，_<strong>当你手中只有一个锤子，你看什么都像钉子</strong>_。</p>
<p>我们完全可以在日常工作中将函数式编程作为一种辅助手段，在条件允许的前提下，借鉴函数式编程中的思路，例如：</p>
<ul>
<li>多使用纯函数减少副作用的影响。</li>
<li>使用柯里化增加函数适用率。</li>
<li>使用 Pointfree 编程风格，减少无意义的中间变量，让代码更且可读性。</li>
<li>……</li>
</ul>
<p>最后，还是那句老生常谈的话：</p>
<blockquote>
<p>没有最好的，只有最适合的</p>
</blockquote>
<p>希望大家在实际项目中，能根据自己的需求选择最适合自己的编程范式，也希望通过学习这种新的编程范式，可以让我们在二进制的世界行走得更加游刃有余。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a class="link"   href="https://juejin.cn/post/6844903936378273799#heading-28" >简明函数式编程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   href="https://www.bilibili.com/video/BV1Ue41117U8/?spm_id_from=333.337.top_right_bar_window_history.content.click" >雨轩讲函数式编程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <tags>
        <tag>函数式编程</tag>
        <tag>柯里化</tag>
        <tag>函数组合</tag>
      </tags>
  </entry>
</search>
